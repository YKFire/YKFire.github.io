<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜" /><meta name="author" content="YKFire" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜" /><meta property="og:description" content="æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜" /><link rel="canonical" href="/posts/Block/" /><meta property="og:url" content="/posts/Block/" /><meta property="og:site_name" content="YKFire" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-04T09:44:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@YKFire" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"YKFire"},"dateModified":"2023-02-04T09:44:00+00:00","datePublished":"2023-02-04T09:44:00+00:00","description":"æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜","headline":"æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Block/"},"url":"/posts/Block/"}</script><title>æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜ | YKFire</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="YKFire"><meta name="application-name" content="YKFire"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/z1.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">YKFire</a></div><div class="site-subtitle font-italic">æ€•ä»€ä¹ˆçœŸç†æ— ç©·ï¼Œè¿›ä¸€å¯¸ï¼Œæœ‰ä¸€å¯¸çš„æ¬¢å–œ.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>é¦–é¡µ</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>åˆ†ç±»</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>æ ‡ç­¾</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>å½’æ¡£</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>å…³äº</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/YKFire" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['1183491613','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> é¦–é¡µ </a> </span> <span>æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> æ–‡ç« </div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="æœç´¢..."> </span> <span id="search-cancel" >å–æ¶ˆ</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜</h1><div class="post-meta text-muted"> <span> å‘è¡¨äº <em class="" data-ts="1675503840" data-df="YYYY/MM/DD" data-toggle="tooltip" data-placement="bottom"> 2023/02/04 </em> </span><div class="d-flex justify-content-between"> <span> ä½œè€… <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="10643 å­—"> <em>59 åˆ†é’Ÿ</em>é˜…è¯»</span></div></div></div><div class="post-content"><h1 id="æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜">æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜</h1><h2 id="ä¸€æœ¬åœ°é”"><span class="mr-2">ä¸€ã€æœ¬åœ°é”</span><a href="#ä¸€æœ¬åœ°é”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="11æœ¬åœ°é”çš„ä½¿ç”¨"><span class="mr-2">1.1ã€æœ¬åœ°é”çš„ä½¿ç”¨</span><a href="#11æœ¬åœ°é”çš„ä½¿ç”¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ¬åœ°é”ä¸»è¦æ˜¯é’ˆå¯¹å•ä½“æœåŠ¡è€Œè¨€çš„ï¼Œé”çš„éƒ½æ˜¯å•ä½“åº”ç”¨å†…çš„è¿›ç¨‹ã€‚</p><p>åƒä¹‹å‰åœ¨å•æœºæƒ…å†µä¸‹å‡ºç°çš„è¯»å†™å¹¶å‘æƒ…å†µã€‚å› ä¸ºå¹¶å‘æƒ…å†µä¸‹ç½‘ç»œå‡ºç°é—®é¢˜æˆ–æ˜¯å‡ºç°å…¶ä»–å¡é¡¿é—®é¢˜ï¼Œå¯¼è‡´æ‰§è¡Œé¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œäº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´æ€§ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/34fe6595111c48459144b4dc83b72e64tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/34fe6595111c48459144b4dc83b72e64tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>è§£å†³å¹¶å‘æœ€å¿«çš„æ–¹å¼å°±æ˜¯åŠ é”å—ï¼Œæˆ‘ä»¬ä¹Ÿå°±ç»™å®ƒæ¥æŠŠé”å§ï¼ŒJavaä¸­çš„é”æ˜¯æœ‰è›®å¤šçš„ï¼Œæˆ‘è¿™é‡Œä¸è¿‡å¤šè®¨è®ºå•¦ï¼ˆsynchronizedã€JUCï¼‰ç­‰ç­‰ã€‚</p><p>æˆ‘æ¡ˆä¾‹ä¸­æ‰€ä½¿ç”¨çš„æ˜¯ JUC åŒ…ä¸‹çš„è¯»å†™é”<code class="language-plaintext highlighter-rouge">ReentrantReadWriteLock</code> ï¼Œæ¯•ç«Ÿä¸èƒ½è®©é”ç›´æ¥é™åˆ¶äº†Redis çš„å‘æŒ¥~ï¼Œè¯»å†™é”æ˜¯è¯»å¹¶å‘ï¼Œå†™ç‹¬å çš„æ¨¡å¼ã€‚</p><p>å¢åŠ è¯»å†™é”ä¹‹åçš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/131d63f48cd243e08bd1c4ded96f949btplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/131d63f48cd243e08bd1c4ded96f949btplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šåŠ ä¸Šé”ä¹‹åçš„æµç¨‹ï¼‰</p><p>æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCacheServiceImpl</span> <span class="kd">implements</span> <span class="nc">IRedisCacheService</span> <span class="o">{</span>


    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MenuMapper</span> <span class="n">menuMapper</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">StringRedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REDIS_MENU_CACHE_KEY</span> <span class="o">=</span> <span class="s">"menu:list"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1ã€ä»ç¼“å­˜ä¸­è·å–</span>
        <span class="nc">String</span> <span class="n">menuJson</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">menuJson</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–"</span><span class="o">);</span>
            <span class="c1">//2ã€ç¼“å­˜ä¸ä¸ºç©ºç›´æ¥è¿”å›</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">menuJson</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//3ã€æŸ¥è¯¢æ•°æ®åº“</span>
        <span class="c1">//ä¸åŠ é”æƒ…å†µä¸‹</span>
        <span class="c1">// List&lt;MenuEntity&gt; noLockList = getMenuJsonFormDb();</span>
        <span class="c1">// åŠ é”æƒ…å†µä¸‹</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="n">getMenuJsonFormDbWithReentrantReadWriteLock</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFormDb</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==&gt;"</span><span class="o">);</span>
        <span class="c1">//ç¼“å­˜ä¸ºç©ºï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;());</span>
        <span class="c1">//4ã€å°†æŸ¥è¯¢çš„ç»“æœï¼Œé‡æ–°æ”¾å…¥ç¼“å­˜ä¸­</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFormDbWithReentrantReadWriteLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==&gt;"</span><span class="o">);</span>
        <span class="c1">// synchronized æ˜¯åŒæ­¥é”ï¼Œæ‰€ä»¥å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œä¼šé˜»å¡å¼ç­‰å¾…</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">menuJson</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">);</span>
            <span class="c1">//åŠ é”æˆåŠŸ... å†æ¬¡åˆ¤æ–­ç¼“å­˜æ˜¯å¦ä¸ºç©º</span>
            <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">menuJson</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–"</span><span class="o">);</span>
                <span class="c1">//2ã€ç¼“å­˜ä¸ä¸ºç©ºç›´æ¥è¿”å›</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">menuJson</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
                <span class="o">});</span>
                <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//ç¼“å­˜ä¸ºç©ºï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;());</span>
            <span class="c1">//4ã€å°†æŸ¥è¯¢çš„ç»“æœï¼Œé‡æ–°æ”¾å…¥ç¼“å­˜ä¸­</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuById</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//return updateMenuByIdNoWithLock(menu);</span>
        <span class="k">return</span> <span class="nf">updateMenuByIdWithReentrantReadWriteLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuByIdNoWithLock</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 1ã€åˆ é™¤ç¼“å­˜</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¸…ç©ºå•æœºRedisç¼“å­˜"</span><span class="o">);</span>
        <span class="c1">// 2ã€æ›´æ–°æ•°æ®åº“</span>
        <span class="k">return</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuByIdWithReentrantReadWriteLock</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 1ã€åˆ é™¤ç¼“å­˜</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¸…é™¤ç¼“å­˜"</span><span class="o">);</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">REDIS_MENU_CACHE_KEY</span><span class="o">);</span>
            <span class="c1">// 2ã€æ›´æ–°æ•°æ®åº“</span>
            <span class="k">return</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>å…·ä½“è¿˜éœ€å¤§å®¶å»äº†è§£~</p><p>æˆ‘è¿™é‡ŒåŠ çš„ JUC ä¸‹çš„è¯»å†™é”ï¼ŒåŸæœ¬æˆ‘æƒ³çš„æ˜¯å¼„çš„JUCçš„é”</p><h3 id="12æœ¬åœ°é”å­˜åœ¨çš„é—®é¢˜"><span class="mr-2">1.2ã€æœ¬åœ°é”å­˜åœ¨çš„é—®é¢˜</span><a href="#12æœ¬åœ°é”å­˜åœ¨çš„é—®é¢˜" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>çœ‹èµ·æ¥æœ¬åœ°é”æ²¡æœ‰å¹¶å‘é—®é¢˜ï¼Œä¸ç®¡æœ‰å¤šå°‘è¯·æ±‚ä¸€èµ·è¿›æ¥ï¼Œéƒ½è¦å»äº‰å–é‚£å”¯ä¸€çš„ä¸€æŠŠé”ï¼ŒæŠ¢åˆ°äº†æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œä¸šåŠ¡</strong>ã€‚</p><p>å•ä½“é¡¹ç›®ä¸­ï¼Œæ¯æŠŠé”é”çš„å°±æ˜¯å½“å‰æœåŠ¡ä¸­çš„å½“å‰çº¿ç¨‹çš„è¯·æ±‚ã€‚</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/d3a289127c194b24ba08504911b718f2tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/d3a289127c194b24ba08504911b718f2tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šå•ä½“æœåŠ¡æ—¶ï¼‰</p><p>ä½†æ˜¯å½“æœåŠ¡éœ€è¦è¿›ä¸€æ­¥æ‰©å±•æ—¶ï¼Œå°±ä¼šéšä¹‹äº§ç”Ÿå‡ºä¸€äº›é—®é¢˜ã€‚</p><p>å¤šæœåŠ¡å¹¶å‘æ—¶ï¼Œå¦‚æœè¿˜æ˜¯åªç»™å½“å‰çº¿ç¨‹åŠ é”ï¼Œ<strong>å¤šä¸ªç”¨æˆ·ä¸€èµ·å°è¯•è·å–é”æ—¶ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶è·å–åˆ°é”ï¼Œå¯¼è‡´å‡ºç°é—®</strong>é¢˜ã€‚</p><p>å¦‚ä¸‹å›¾ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/3c161c6b725349df811ea1a72c7fa035tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/3c161c6b725349df811ea1a72c7fa035tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a> <strong>æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å•ç‹¬çš„ï¼ŒåŠ é”æ“ä½œä¹Ÿåªæ˜¯ç»™è‡ªå·±çš„ï¼Œå¤§å®¶ä¸èƒ½å…±äº«</strong>ï¼Œé‚£ä¹ˆå®é™…ä¸Šåœ¨é«˜å¹¶å‘çš„æ—¶å€™ï¼Œæ˜¯æ ¹æœ¬æ²¡æ•ˆæœçš„ã€‚</p><p>æˆ‘1å·æœåŠ¡æŠ¢åˆ°äº†é”ï¼Œè¿˜æ²¡ç­‰åˆ°é‡Šæ”¾ï¼Œ2å·æœåŠ¡åˆè·å–åˆ°äº†é”ï¼Œæ¥ç€3å·ã€4å·ç­‰ç­‰ï¼Œå¤§å®¶éƒ½å¯ä»¥æ“ä½œæ•°æ®åº“ï¼Œè¿™æŠŠé”ä¹Ÿå°±å¤±å»äº†å®ƒè¯¥æœ‰çš„ä½œç”¨ã€‚</p><p>å› æ­¤å°±è¿›ä¸€æ­¥å‡ºç°äº†åˆ†å¸ƒå¼é”ï¼Œæ¥ä¸‹æ¥ç»§ç»­çœ‹å§ã€‚</p><h2 id="äºŒåˆ†å¸ƒå¼é”çš„ä»‹ç»"><span class="mr-2">äºŒã€åˆ†å¸ƒå¼é”çš„ä»‹ç»</span><a href="#äºŒåˆ†å¸ƒå¼é”çš„ä»‹ç»" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><strong>æœ¬åœ°é”å¤±æ•ˆæ˜¯å› ä¸ºæ— æ³•é”ä½å„ä¸ªåº”ç”¨çš„è¯»å†™è¯·æ±‚ï¼Œå¤±æ•ˆçš„æ ¹æœ¬åŸå› å°±æ˜¯å…¶ä»–çš„æœåŠ¡æ— æ³•æ„ŸçŸ¥åˆ°æ˜¯å¦å·²ç»æœ‰è¯·æ±‚ä¸Šé”äº†ï¼Œå³æ— æ³•å…±äº«é”ä¿¡æ¯</strong>ã€‚</p><p>åˆ†å¸ƒå¼é”ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å°†åŠ é”çš„è¿™ä¸€ä¸ªæ“ä½œï¼Œå•ç‹¬çš„æŠ½å–å‡ºæ¥äº†ï¼Œè®©æ¯ä¸ªæœåŠ¡éƒ½èƒ½æ„ŸçŸ¥åˆ°ã€‚</p><p>ä¹‹å‰å°±è¯´äº†ï¼Œè½¯ä»¶æ¶æ„è®¾è®¡ä¸­ï¼Œâ€<strong>æ²¡æœ‰ä»€ä¹ˆæ˜¯åŠ ä¸€å±‚è§£å†³ä¸äº†çš„ï¼Œå¦‚æœåŠ ä¸€å±‚ä¸è¡Œå°±å†åŠ ä¸€å±‚</strong>â€œã€‚</p><p>è¿™é‡Œå…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ç¢°å·§è¿™ä¸€å±‚å¯ä»¥åœ¨Redisä¸­å®ç°ç½¢äº†ï¼Œçœ‹èµ·æ¥å€’æ˜¯æ²¡æœ‰å¤šåŠ ä¸€å±‚ï¼Œä½†å¦‚æœæ˜¯ç”¨<code class="language-plaintext highlighter-rouge">Zookeeper</code> æˆ–è€…å…¶ä»–æ–¹å¼æ¥å®ç°ï¼Œä½ ä¼šå‘ç°æ¶æ„ä¸­ä¼šå¤šä¸€å±‚æ»´ã€‚</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/5b3032e9159d4a49981cddc77bf7338ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/5b3032e9159d4a49981cddc77bf7338ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>å…¶å®ç†è§£æ€æƒ³å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§çš„ï¼Œ</p><ul><li>Redis å®ç°åˆ†å¸ƒå¼é”<li>Zookeeper å®ç°åˆ†å¸ƒå¼é”<li>MySQL ä¸“é—¨ç”¨ä¸€å¼ è¡¨æ¥è®°å½•ä¿¡æ¯ï¼Œå®ç°åˆ†å¸ƒå¼é”ï¼Œä¹Ÿæ˜¯å¸¸è¯´çš„åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ã€‚</ul><p>æ‰€è°“çš„åŠ é”ï¼Œå…¶æœ¬è´¨ä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªä¿¡å·é‡æ˜¯å¦å­˜åœ¨ç½¢äº†ï¼Œåˆ†å¸ƒå¼ä¹Ÿå°±æ˜¯æŠŠè¿™ä¸ªä¿¡å·é‡ä»æœ¬åœ°çº¿ç¨‹ä¸­ï¼Œç§»æ¤åˆ°äº†Redisä¸­å­˜å‚¨ï¼Œè®©æ‰€æœ‰æœåŠ¡ä¸­çš„è¯·æ±‚éƒ½èƒ½å…±äº«ä¸€æŠŠé”ã€‚çŸ¥é“æ€æƒ³åï¼Œå®ç°æ–¹å¼å¹¶ä¸å±€é™ï¼Œå¤§å®¶ä¹Ÿä¸è¦å±€é™äº†è‡ªå·±ï¼Œéƒ½å·²ç»ç«™åœ¨å·¨äººè‚©è†€ä¸Šï¼Œå°±è¦æƒ³çš„æ›´å¤šä¸€äº›~</p><p>æˆ‘é‡‡ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œä¸»è¦åŸå› ï¼š</p><ol><li>Redis æ˜¯åŸºäºå†…å­˜æ“ä½œçš„æ•°æ®åº“ï¼Œé€Ÿåº¦å¿«ï¼›<li>å¸‚åœºä¸»æµçš„æ•°æ®åº“ï¼Œæ‹¥æœ‰è¾ƒå¤šçš„å‚è€ƒèµ„æ–™ï¼›<li>Redis ç¤¾åŒºå¼€å‘è€…æ´»è·ƒï¼Œå¹¶ä¸” Redis å¯¹åˆ†å¸ƒå¼é”æœ‰è¾ƒå¥½çš„æ”¯æŒï¼›</ol><hr /><p>ä»Šå¤©æ‰€è®¨è®ºçš„ï¼Œä¸»è¦å°±æ˜¯é’ˆå¯¹äºä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œæµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/1ba6f176c60e4bbb83f7c4d40a64313ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/1ba6f176c60e4bbb83f7c4d40a64313ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šæ­¤å›¾ä¸ºè·å–é”çš„å¤§è‡´æµç¨‹ï¼Œå…¶ä¹‹åçš„æ„å»ºç¼“å­˜ã€é‡Šæ”¾é”ç­‰æœªåœ¨å›¾ä¸Šæ‰€æ ‡æ˜ï¼‰</p><p>è™½ç„¶ä¸¤ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ•°æ®åº“ä»£ç å‰ï¼Œéƒ½éœ€è¦å…ˆè·å–åˆ°è¯»é”æˆ–è€…å†™é”ï¼Œä»¥ç¡®ä¿å¹¶å‘æ—¶æ‰§è¡Œçš„æ­£ç¡®æ€§~</p><p>æ¥ä¸‹æ¥å°±æ˜¯è¯´åˆ†å¸ƒå¼é”çš„å®ç°å•¦~</p><h2 id="ä¸‰åˆ†å¸ƒå¼é”çš„å®ç°"><span class="mr-2">ä¸‰ã€åˆ†å¸ƒå¼é”çš„å®ç°</span><a href="#ä¸‰åˆ†å¸ƒå¼é”çš„å®ç°" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>åœ¨ä¸Šä¸€å°èŠ‚å°±å·²è¯´åˆ†å¸ƒå¼é”çš„å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œå¤§çš„èŒƒå›´ä¸­æœ‰ Redisã€Zookeeperã€MySQLç­‰å®ç°æ–¹å¼ï¼Œæˆ‘å…·ä½“è®²çš„æ˜¯ä»¥ Redis çš„å®ç°ã€‚</p><p>è®²è§£è¿‡ç¨‹ä¹Ÿæ˜¯é€æ­¥æ·±å…¥ï¼Œé€æ­¥æ¼”è¿›ï¼Œå¹¶éæ˜¯ç›´æ¥ä¸¢å‡ºå®ç°ä»£ç ï¼Œé’ˆå¯¹ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œä¸ºä»€ä¹ˆæœ€ç»ˆæ˜¯è¿™æ ·ï¼Œè®©å¤§å®¶æœ‰ä¸€ä¸ªäº†è§£è¿‡ç¨‹ã€‚</p><p>é”çš„ç¬¬ä¸€ä¸ªè¦æ±‚å°±æ˜¯è¦èƒ½åšåˆ°äº’æ–¥ï¼Œè€Œåœ¨Redisä¸­æœ€å®¹æ˜“æƒ³åˆ°ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„ï¼Œæ— ç–‘å°±æ˜¯ <code class="language-plaintext highlighter-rouge">setnx</code> å‘½ä»¤ã€‚</p><p>æˆ‘ä»¬å°±ä»¥ <code class="language-plaintext highlighter-rouge">setnx</code>æŠ›ç –å¼•ç‰ï¼Œæ¥å¯¹åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œåšä¸€ä¸ªé€æ­¥æ¼”è¿›çš„è®¨è®ºã€‚</p><h3 id="31setnx"><span class="mr-2">3.1ã€setnx</span><a href="#31setnx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">Redis Setnx</code>ï¼ˆ <strong>SET IF Not EXists</strong> ï¼‰å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸º key è®¾ç½®æŒ‡å®šçš„å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ç­‰åŒ <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fset.html">SET</a> å‘½ä»¤ã€‚å½“ <code class="language-plaintext highlighter-rouge">key</code>å­˜åœ¨æ—¶ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚</p><p>è¿”å›å€¼</p><ul><li>å¦‚æœkeyè®¾ç½®æˆåŠŸäº†ï¼Œåˆ™è¿”å›<code class="language-plaintext highlighter-rouge">1</code><li>å¦‚æœkeyè®¾ç½®å¤±è´¥äº†ï¼Œåˆ™è¿”å›<code class="language-plaintext highlighter-rouge">0</code></ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">redis</span><span class="o">&gt;</span> <span class="n">SETNX</span> <span class="n">mykey</span> <span class="nv">"Hello"</span>
<span class="p">(</span><span class="nb">integer</span><span class="p">)</span> <span class="mi">1</span>
<span class="n">redis</span><span class="o">&gt;</span> <span class="n">SETNX</span> <span class="n">mykey</span> <span class="nv">"World"</span>
<span class="p">(</span><span class="nb">integer</span><span class="p">)</span> <span class="mi">0</span>
<span class="n">redis</span><span class="o">&gt;</span> <span class="k">GET</span> <span class="n">mykey</span>
<span class="nv">"Hello"</span>
<span class="err">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>è½¬æ¢åˆ°åŠ é”çš„æµç¨‹ä¸­å°±æ˜¯ï¼Œå½“è¯»è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œå…ˆç”¨<code class="language-plaintext highlighter-rouge">setnx</code>å‘½ä»¤å¾€ Redis ä¸­è®¾ç½®ä¸€ä¸ªå€¼ï¼Œè¿”å›<code class="language-plaintext highlighter-rouge">1</code>åˆ™æ˜¯åŠ é”æˆåŠŸäº†ï¼Œè¿”å›<code class="language-plaintext highlighter-rouge">0</code>åˆ™æ˜¯åŠ é”å¤±è´¥äº†ã€‚</p><p>å¦‚ä½•é‡Šæ”¾é”å‘¢ï¼Ÿ</p><p><code class="language-plaintext highlighter-rouge">setnx</code>å…¶æœ¬è´¨å’Œ<code class="language-plaintext highlighter-rouge">set</code>å‘½ä»¤å…¶å®å·®ä¸å¤šï¼Œéƒ½æ˜¯å¾€ Redis ä¸­è®¾ç½®ä¸€ä¸ªå€¼ï¼Œé‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤è¿™ä¸ª<code class="language-plaintext highlighter-rouge">key</code>å€¼ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">del key</code> å‘½ä»¤åˆ é™¤å³ç­‰äºé‡Šæ”¾é”~</p><p>æ€è·¯ğŸ‘¨â€ğŸ«ï¼š</p><ul><li>è¯»è¯·æ±‚è¿‡æ¥ï¼Œåˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå­˜åœ¨ç«‹é©¬è¿”å›ï¼Œä¸å­˜åœ¨åˆ™å¾€ä¸‹èµ°ã€‚<li>è¯»è¯·æ±‚å°è¯•è·å–è¯»é”ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">setnx</code> å‘½ä»¤<li>å‘Redisä¸­å°è¯•setä¸€ä¸ªå€¼ï¼Œå½“ä¸”ä»…å½“å€¼ä¸å­˜åœ¨æ—¶è®¾ç½®æˆåŠŸã€‚<li>è®¾ç½®æˆåŠŸè¿”å› 1ï¼Œå¦åˆ™è¿”å› 0<li>è·å–æˆåŠŸåï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜ã€‚</ul><p>ä»£ç æ¡ˆä¾‹å®ç°ï¼š</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SetNxExLockServiceImpl</span> <span class="kd">implements</span> <span class="nc">ISetNxExLockService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MenuMapper</span> <span class="n">menuMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list:lock"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span> <span class="o">=</span> <span class="s">"lock"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®</span>
        <span class="nc">String</span> <span class="n">menuJson</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menuJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®"</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">menuJson</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">getMenuJsonFormDbWithLock</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é—®é¢˜ï¼šæ­»é”é—®é¢˜ï¼Œ å¦‚æœåœ¨æ‰§è¡Œè§£é”æ“ä½œä¹‹å‰ï¼ŒæœåŠ¡çªç„¶å®•æœºï¼Œé‚£ä¹ˆé”å°±æ°¸è¿œæ— æ³•è¢«é‡Šæ”¾ï¼Œä»è€Œé€ æˆæ­»é”é—®é¢˜
     * è§£å†³æ–¹æ¡ˆ: å› ä¸º Redis çš„æ›´æ–°ï¼Œç°åœ¨ setIfAbsent æ”¯æŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè€Œæ— éœ€åˆ†æˆä¸¤æ­¥æ“ä½œã€‚
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFormDbWithLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==&gt;"</span><span class="o">);</span>
        <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”æˆåŠŸ..."</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;());</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// é‡Šæ”¾é”</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•..."</span><span class="o">);</span>
            <span class="c1">//åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶</span>
            <span class="c1">//ä¼‘çœ ä¸€ç™¾æ¯«ç§’</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// æ‰‹åŠ¨å®ç°è‡ªæ—‹</span>
            <span class="k">return</span> <span class="nf">getMenuJsonFormDbWithLock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

        <span class="c1">// æ›´æ–°æ“ä½œ</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuById</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">updateMenuByIdWithLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuByIdWithLock</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span><span class="o">);</span>
            <span class="nc">Boolean</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ›´æ–°æ“ä½œï¼šè·å–åˆ†å¸ƒå¼é”æˆåŠŸ===&gt;"</span><span class="o">);</span>
                <span class="c1">// åˆ é™¤ç¼“å­˜</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
                    <span class="c1">// æ›´æ–°æ•°æ®åº“</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="c1">// ä¸€å®šè¦é‡Šæ”¾é”ï¼Œä»¥å…é€ æˆæ­»é”é—®é¢˜</span>
                    <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">update</span><span class="o">;</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="nf">updateMenuByIdWithLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

<span class="o">}</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">æ³¨æ„</code>ï¼šä»£ç ä¸­æœ‰åŠ é”æ“ä½œï¼Œå°±ä¸€å®šè¦è®°å¾—å°†è§£é”æ“ä½œæ”¾åˆ°äº†finallyæ‰§è¡Œï¼Œä»¥ä¿è¯åœ¨ä»£ç å±‚é¢ä¸ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</p><p>ä½ è§‰å¾—ä¸Šé¢çš„æ¡ˆä¾‹å­˜åœ¨ä»€ä¹ˆæ ·çš„é—®é¢˜å—ï¼Ÿ</p><p>å’‹ä¸€çœ‹ï¼Œä¸Šé¢çš„å¥½åƒç¡®å®å®ç°äº†åˆ†å¸ƒå¼é”ï¼Œ<code class="language-plaintext highlighter-rouge">setIfAbsent()</code>æ–¹æ³•å®ç°äº†é”çš„äº’æ–¥æ€§ï¼ŒRedis ä¹Ÿè®©é”å¾—åˆ°å…±äº«ï¼Œä½†æ˜¯çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ</p><p><strong>æ€è€ƒ</strong>ğŸ§ï¼š</p><p>å¦‚æœæŸä¸ªæ—¶åˆ»ä»£ç æ‰§è¡Œåˆ°é‡Šæ”¾é”çš„é‚£ä¸€æ­¥ï¼ŒæœåŠ¡çªç„¶æŒ‚äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå°±æ„å‘³ç€é”é‡Šæ”¾å¤±è´¥äº†å‹’ï¼Œé‚£ä¹ˆä¹Ÿå°±é€ æˆäº†æœ€å¤§çš„é—®é¢˜<strong>æ­»é”</strong>ï¼Œå› ä¸ºæ²¡æœ‰è§£é”æ“ä½œï¼Œé”ä¹Ÿå°±å°†æ— æ³•è¢«é‡Šæ”¾ã€‚</p><p>é‚£è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p><p>æœ€ä½³çš„æ–¹å¼å°±æ˜¯ç»™é”<strong>è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´</strong>~</p><h3 id="32è§£å†³æ­»é”é—®é¢˜"><span class="mr-2">3.2ã€è§£å†³æ­»é”é—®é¢˜</span><a href="#32è§£å†³æ­»é”é—®é¢˜" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ€å®¹æ˜“æƒ³åˆ°ä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç»™è¿™ä¸ª<strong>åˆ†å¸ƒå¼é”åŠ ä¸ªè¿‡æœŸæ—¶é—´</strong>ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">3sã€5s</code>ä¹‹ç±»ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">EXPIRE</code>è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´</p><p>ä½†å¦‚æœæƒ³åˆ°çš„æ˜¯è¿™ç§ï¼š</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>redis&gt; SETNX mykey <span class="s2">"Hello"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt; EXPIRE mykey 10
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt; SETNX mykey <span class="s2">"World"</span>
<span class="o">(</span>integer<span class="o">)</span> 0
redis&gt; TTL mykey
<span class="o">(</span>integer<span class="o">)</span> 8
redis&gt; GET mykey
<span class="s2">"Hello"</span>
å¤åˆ¶ä»£ç 
</pre></table></code></div></div><p>å¦‚æœæ˜¯è¿™ä¹ˆå®ç°çš„è¯ï¼Œå’±ä»¬å°±è¿˜æ˜¯å¯¹äº Redis äº†è§£å¤ªå°‘äº†ã€‚</p><p>é¦–å…ˆè¯´è¯´è¿™æ ·æ“ä½œä¼šå‡ºç°çš„é—®é¢˜ï¼š</p><ol><li>æˆ‘æˆåŠŸè®¾ç½®äº†<code class="language-plaintext highlighter-rouge">key</code>ï¼Œä½†æ˜¯è¿˜æ²¡æ‰§è¡Œåˆ°è®¾ç½®æ—¶é—´é‚£ä¸€æ­¥ï¼Œåº”ç”¨ç¨‹åºçªç„¶æŒ‚äº†ï¼Œå¯¼è‡´æ­»é”é—®é¢˜äº§ç”Ÿã€‚<li>æˆ–è€…æ˜¯æˆåŠŸè®¾ç½®äº† <code class="language-plaintext highlighter-rouge">key</code> åï¼ŒRedis æœåŠ¡çªç„¶å´©æºƒäº†ï¼Œä¸å¹²æ´»äº†ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†åé¢çš„<code class="language-plaintext highlighter-rouge">EXPIRE</code>æ— æ³•æ‰§è¡ŒæˆåŠŸï¼ŒåŒæ ·ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚</ol><p>ã€<strong>é‡ç‚¹</strong>ã€‘ï¼šå› ä¸ºåŠ é”å’Œè®¾ç½®æ—¶é—´ä¸æ˜¯<strong>ä¸€ä¸ªåŸå­æ€§æ“ä½œ</strong></p><p>æ€ä¹ˆæ‰èƒ½å°†åŠ é”å’Œè®¾ç½®é”æ—¶é—´å˜æˆä¸€ä¸ªåŸå­æ“ä½œå‘¢ï¼Ÿ</p><p>å…¶å®è¿™ä¸€æ­¥Rediså·²ç»å¸®æˆ‘ä»¬åšå¥½å•¦~</p><p>Redis ä¸­çš„<code class="language-plaintext highlighter-rouge">set</code>å‘½ä»¤æ˜¯å¯ä»¥æ·»åŠ å‚æ•°çš„ï¼Œä¸€æ¡setå‘½ä»¤å³å¯å®ç°<code class="language-plaintext highlighter-rouge">SETNX+EXPIRE</code>æ•ˆæœï¼Œå°†åŠ é”å’Œè®¾ç½®æ—¶é—´å˜æˆä¸€ä¸ªåŸå­æ€§æ“ä½œï¼Œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ã€‚</p><p>å®Œæ•´å‘½ä»¤å‚æ•°ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fcommands%2Fset%2F">æ–‡æ¡£é“¾æ¥</a></p><blockquote><div class="table-wrapper"><table><tbody><tr><td>SET key value [EX seconds<td>PX milliseconds<td>KEEPTTL] [NX<td>XX] [GET]</table></div></blockquote><ul><li><code class="language-plaintext highlighter-rouge">EX</code> <em>seconds</em> â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’<li><code class="language-plaintext highlighter-rouge">PX</code> <em>milliseconds</em> â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’<li><code class="language-plaintext highlighter-rouge">NX</code> â€“ åªæœ‰é”®keyä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼<li><code class="language-plaintext highlighter-rouge">XX</code> â€“ åªæœ‰é”®keyå­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼<li><code class="language-plaintext highlighter-rouge">KEEPTTL</code> â€“ è·å– key çš„è¿‡æœŸæ—¶é—´<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fget.html">GET</a> â€“ è¿”å› key å­˜å‚¨çš„å€¼ï¼Œå¦‚æœ key ä¸å­˜åœ¨è¿”å›ç©º</ul><p><strong>æ³¨æ„:</strong> ç”±äº<code class="language-plaintext highlighter-rouge">SET</code>å‘½ä»¤åŠ ä¸Šé€‰é¡¹å·²ç»å¯ä»¥å®Œå…¨å–ä»£<code class="language-plaintext highlighter-rouge">SETNX</code>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fsetex.html">SETEX</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fpsetex.html">PSETEX</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fgetset.html">GETSET</a>,çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ï¼Œrediså¯èƒ½ä¼šä¸æ¨èä½¿ç”¨å¹¶ä¸”æœ€ç»ˆæŠ›å¼ƒè¿™å‡ ä¸ªå‘½ä»¤ã€‚</p><p>è¿”å›å€¼</p><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Ftopics%2Fprotocol.html%23simple-string-reply">å­—ç¬¦ä¸²</a>: å¦‚æœ<code class="language-plaintext highlighter-rouge">SET</code>å‘½ä»¤æ­£å¸¸æ‰§è¡Œé‚£ä¹ˆå›è¿”å›<code class="language-plaintext highlighter-rouge">OK</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Ftopics%2Fprotocol.html%23bulk-string-reply">å¤šè¡Œå­—ç¬¦ä¸²</a>: ä½¿ç”¨ GET é€‰é¡¹ï¼Œè¿”å› key å­˜å‚¨çš„å€¼ï¼Œå¦‚æœ key ä¸å­˜åœ¨è¿”å›ç©º: å¦åˆ™å¦‚æœåŠ äº†<code class="language-plaintext highlighter-rouge">NX</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">XX</code>é€‰é¡¹ï¼Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fset.html">SET</a> æ²¡æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šè¿”å›nilã€‚</p><p><strong>ä¾‹å­</strong>ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/1aaf725ade824172be214bf9d33c5d82tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/1aaf725ade824172be214bf9d33c5d82tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>ä»è¿™ä¸ªå°æ¡ˆä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ç¬¦åˆæˆ‘ä»¬è¦çš„å‘½ä»¤çš„~</p><p>Java ä»£ç å®ç°ï¼šè¿™ä¸€æ­¥çš„ä»£ç å®ç°å’Œä¸Šä¸€å°èŠ‚ç›¸æ¯”ï¼Œä»…æ”¹åŠ¨äº†ä¸€è¡Œä»£ç ï¼š</p><p>ä¸Šä¸€å°èŠ‚ï¼š</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span><span class="o">);</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼š</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>å°±è¿™æ ·ï¼Œå†é‚£æ ·ï¼Œå†è¿™æ ·ï¼Œä½ çœ‹æ­»é”é—®é¢˜å°±è¢«è§£å†³å•¦ğŸ˜œ</p><p><strong>æ­»é”é—®é¢˜ç¡®å®è¢«è§£å†³äº†ï¼Œç°åœ¨ä½ è§‰å¾—è¿˜æœ‰é—®é¢˜å—</strong>ï¼Ÿ</p><p>æˆ‘ä»¬æŠŠå®ƒçš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æ‹†åˆ†æ¥çœ‹ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢çš„è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p><p>å‡è®¾æˆ‘ä»¬çº¦å®šé”è¿‡æœŸæ—¶é—´ä¸º<code class="language-plaintext highlighter-rouge">5s</code>ï¼Œä½†æ˜¯æ‰§è¡Œè¿™ä¸ªä¸šåŠ¡æ—¶çªç„¶å¡èµ·æ¥ï¼Œæ­¤ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†æˆ‘ä»¬é¢„ä¼°çš„ <code class="language-plaintext highlighter-rouge">5s</code>ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p><p>ç¬¬ä¸€æ¡çº¿ç¨‹æŠ¢åˆ°é”ï¼Œä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œç¬¬ä¸€æ¡çº¿ç¨‹æ‰€æŒæœ‰çš„é”è¢«<strong>è‡ªåŠ¨é‡Šæ”¾</strong>ï¼›æ­¤æ—¶ç¬¬äºŒæ¡çº¿ç¨‹æ‹¿åˆ°é”ï¼Œå‡†å¤‡æ‰§è¡Œä¸šåŠ¡ï¼Œåˆšå¥½ç¬¬ä¸€æ¡çº¿ç¨‹ä¸šåŠ¡æ‰§è¡Œå®Œæˆï¼Œç…§å¸¸æ‰§è¡Œäº†é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œ<strong>å¯¼è‡´ç¬¬äºŒæ¡çº¿ç¨‹æŒæœ‰çš„é”è¢«ç¬¬ä¸€æ¡çº¿ç¨‹æ‰€é‡Šæ”¾ï¼Œé”è¢«å…¶ä»–äººé‡Šæ”¾</strong>ã€‚</p><p>è¿™ä¸ªæƒ…å†µä¸­å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œé”è¢«è‡ªåŠ¨é‡Šæ”¾<li>é”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œå¯¼è‡´ä¸šåŠ¡å‡ºç°é—®é¢˜</ol><p>å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¸¸è¯´çš„<strong>é”ç»­æœŸé—®é¢˜</strong>ï¼Œè¿™ç‚¹ä¹‹ååœ¨ä½¿ç”¨ Redission æ—¶å†ç»†è°ˆã€‚</p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå°±æ¯”è¾ƒå¥½è§£å†³äº†ï¼Œæˆ‘ä»¬æ¯æ¬¡åŠ é”çš„æ—¶å€™ï¼Œå¸¦ä¸Šè‡ªå·±çš„èº«ä»½æ ‡è¯†ï¼Œåœ¨è§£é”çš„æ—¶å€™ï¼Œè¿›è¡Œä¸€æ¬¡åˆ¤æ–­å³å¯ã€‚</p><p>æ¥ç€å¾€ä¸‹çœ‹å§ ğŸ‘‡</p><h3 id="33é”è¢«å…¶ä»–äººé‡Šæ”¾è¯¥æ€ä¹ˆåŠ"><span class="mr-2">3.3ã€é”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</span><a href="#33é”è¢«å…¶ä»–äººé‡Šæ”¾è¯¥æ€ä¹ˆåŠ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æˆ‘ä»¬æ¯æ¬¡åŠ é”çš„æ—¶å€™ï¼Œå¸¦ä¸Šè‡ªå·±çš„èº«ä»½æ ‡è¯†ï¼Œåœ¨è§£é”çš„æ—¶å€™ï¼Œè¿›è¡Œä¸€æ¬¡åˆ¤æ–­å³å¯ã€‚</p><p>æ¯”å¦‚ï¼šåŠ é”çš„æ—¶å€™ï¼Œç”Ÿæˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">UUID</code>ä½œä¸º <code class="language-plaintext highlighter-rouge">KEY</code>ï¼Œé‡Šæ”¾é”æ—¶ï¼Œè·å–ä¸€ä¸‹é”ï¼Œåˆ¤æ–­ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">UUID</code>æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™æ‰§è¡Œåˆ é™¤ï¼Œå¦åˆ™ä¸æ‰§è¡Œåˆ é™¤ã€‚</p><p>åœ¨ Redis ä¸­å‘½ä»¤æ¼”ç¤ºå¦‚ä¸‹ï¼š</p><p>è®¾ç½®é”ï¼š<code class="language-plaintext highlighter-rouge">set uuid "lock" NX EX 60</code></p><p>é‡Šæ”¾é”ï¼š1ã€<code class="language-plaintext highlighter-rouge">get uuid</code>ï¼Œèº«ä»½æ ‡è¯†ç›¸ç­‰ï¼Œåˆ™æ‰§è¡Œ2ï¼›2ã€<code class="language-plaintext highlighter-rouge"> del uuid</code></p><p><a href="/assets/blog_res/2023-02-04-Block.assets/f523754707e44c03ad56e56f993e4f25tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/f523754707e44c03ad56e56f993e4f25tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>Java ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SetNxExLockServiceImpl</span> <span class="kd">implements</span> <span class="nc">ISetNxExLockService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MenuMapper</span> <span class="n">menuMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list:lock"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span> <span class="o">=</span> <span class="s">"lock"</span><span class="o">;</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®</span>
        <span class="nc">String</span> <span class="n">menuJson</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menuJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®"</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">menuJson</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">getMenuJsonFromDbWithRedisLock</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * é—®é¢˜ï¼šé”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œè¿™è¯¥å¦‚ä½•å¤„ç†ã€‚
     * åŠ é”çš„æ—¶å€™ï¼Œå°†å€¼ç»™å®šä½ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ UUID ï¼‰
     * 1ã€è§£é”ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±è·å–çš„é‚£æŠŠé”ï¼Œ
     * 2ã€ç¡®å®šæ˜¯ä¸€æŠŠé”å°±æ‰§è¡Œ è§£é”é”æ“ä½œ
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFromDbWithRedisLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==&gt;"</span><span class="o">);</span>
        <span class="c1">// ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´</span>
        <span class="nc">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”æˆåŠŸ..."</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;());</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// è·å–é”ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹çš„é”</span>
                <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">uuid</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// ç¡®å®šæ˜¯åŒä¸€æŠŠé”ï¼Œ æ‰é‡Šæ”¾é”</span>
                    <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="cm">/**
             * é‚£è¿™æ ·å°±æ²¡æœ‰é—®é¢˜äº†å—ï¼Ÿ
             * å¹¶ä¸æ˜¯ã€‚
             * è¿™é‡Œå­˜åœ¨çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåˆ é™¤æ“ä½œå·²ç»ä¸åœ¨æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œäº†ã€‚
             * 1ã€ä¸€ä¸ªæ˜¯æŸ¥è¯¢åˆ¤æ–­
             * 2ã€ç¬¬äºŒä¸ªæ‰æ˜¯è§£é”æ“ä½œ
             * é‚£ä¹ˆåˆä¼šæ‹†åˆ†æˆï¼Œå¦‚æœæˆ‘ç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸï¼Œç¬¬äºŒæ­¥æ‰§è¡Œå¤±è´¥çš„åœºæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠå®ƒå˜æˆåŸå­æ“ä½œæ‰è¡Œã€‚
             */</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•..."</span><span class="o">);</span>
            <span class="c1">//åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶</span>
            <span class="c1">//ä¼‘çœ ä¸€ç™¾æ¯«ç§’</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nf">getMenuJsonFromDbWithRedisLock</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuById</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//        return updateMenuByIdWithLock(menu);</span>
        <span class="c1">//        return updateMenuWithExpireLock(menu);</span>
        <span class="k">return</span> <span class="nf">updateMenuWithRedisLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
    <span class="o">}</span>

  
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuWithExpireLock</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´</span>
        <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="nc">Boolean</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ›´æ–°æ“ä½œï¼šè·å–åˆ†å¸ƒå¼é”æˆåŠŸ===&gt; æ¸…é™¤ç¼“å­˜"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// åˆ é™¤ç¼“å­˜</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
                <span class="c1">// æ›´æ–°æ•°æ®åº“</span>
                <span class="n">update</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// ä¸€å®šè¦é‡Šæ”¾é”ï¼Œä»¥å…é€ æˆæ­»é”é—®é¢˜</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">update</span><span class="o">;</span>
        <span class="o">}</span>  <span class="k">else</span><span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nf">updateMenuWithExpireLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>é‚£ä¹ˆè¿™å°±æ²¡æœ‰é—®é¢˜äº†å—ï¼Ÿ</p><p>å¹¶ä¸æ˜¯ã€‚è¿™é‡Œå­˜åœ¨çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåˆ é™¤æ“ä½œåˆå·²ç»ä¸å†æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œäº†ã€‚</p><ul><li>ç¬¬ä¸€æ­¥æ˜¯æŸ¥è¯¢åˆ¤æ–­<li>ç¬¬äºŒæ­¥æ‰æ˜¯è§£é”æ“ä½œ</ul><p>é‚£ä¹ˆç»§è€Œåˆä¼šå‡ºç°ï¼Œæˆ‘ç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸï¼Œç¬¬äºŒæ­¥æ‰§è¡Œå¤±è´¥çš„åœºæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æŠŠå®ƒå˜æˆåŸå­æ€§æ“ä½œæ‰è¡Œã€‚</p><p>è¿™ä¸ªæ—¶å°±è¦ç”¨åˆ°äº† Redis ä¸­çš„ lua è„šæœ¬å•¦~</p><p>è®©å®ƒå»å¸®åŠ©æˆ‘ä»¬å®ç°å°†åˆ¤æ–­å’Œè§£é”å˜æˆä¸€æ­¥åŸå­æ€§æ“ä½œ~ æ¥ç€çœ‹å§</p><h3 id="34lua-è„šæœ¬å®ç°åˆ†å¸ƒå¼é”"><span class="mr-2">3.4ã€lua è„šæœ¬å®ç°åˆ†å¸ƒå¼é”</span><a href="#34lua-è„šæœ¬å®ç°åˆ†å¸ƒå¼é”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å…¶å®æœ‰é˜…è¯»è¿‡ Redis å®˜æ–¹æ–‡æ¡£çš„æœ‹å‹ï¼Œåœ¨çœ‹ä¸Šé¢çš„é‚£ä¸ª <code class="language-plaintext highlighter-rouge">set</code>å‘½ä»¤çš„æ–‡æ¡£æ—¶ï¼Œå°±ä¼šå‘ç°ï¼Œå…¶å®æ»‘åˆ°ä¸‹åŠéƒ¨åˆ†ï¼ŒRedis å°±æœ‰æåˆ°ä¸æ¨èä½¿ç”¨<code class="language-plaintext highlighter-rouge">SET resource-name anystring NX EX max-lock-time</code> è¿™ä¸ªç®€å•æ–¹æ³•æ¥å®ç°åˆ†å¸ƒå¼é”~</p><p>å¹¶ä¸”ä¹Ÿç»™å‡ºäº†ç›¸åº”çš„å»ºè®®ï¼šå¦‚ä¸‹å›¾</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/672f255cac16449496e395329feafe53tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/672f255cac16449496e395329feafe53tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><pre><code class="language-vbnet">if redis.call("get",KEYS[1]) == ARGV[1]
then
    return redis.call("del",KEYS[1])
else
    return 0
end
å¤åˆ¶ä»£ç 
</code></pre><p>æˆ‘ä»¬ä½¿ç”¨çš„å…¶å®å°±æ˜¯ä¸Šé¢çš„è„šæœ¬ï¼Œå“ˆå“ˆ</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SetNxExLockServiceImpl</span> <span class="kd">implements</span> <span class="nc">ISetNxExLockService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MenuMapper</span> <span class="n">menuMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK</span> <span class="o">=</span> <span class="s">"set:nx:ex:menu:list:lock"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_NX_EX_MENU_LIST_LOCK_VALUE</span> <span class="o">=</span> <span class="s">"lock"</span><span class="o">;</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®</span>
        <span class="nc">String</span> <span class="n">menuJson</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">menuJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®"</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">menuEntityList</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">menuJson</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="n">menuEntityList</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">getMenuJsonFormDbWithLock</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é—®é¢˜ï¼šé‡Šæ”¾é”æ“ä½œ ä¸¢å¤± åŸå­æ€§
     * è§£å†³æ–¹æ¡ˆ: lua è„šæœ¬
     * æ—¢ç„¶åˆ é™¤æ“ä½œå˜æˆäº†ä¸¤æ­¥ï¼Œå¤±å»äº†åŸå­æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒæ”¹æˆä¸€æ­¥å°±è¡Œå•¦å‘€ï¼Œ
     * æ­¤æ—¶å°±å¾—ç”¨ä¸Šæˆ‘ä»¬çš„ lua è„šæœ¬äº†
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFormDbWithLuaLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==&gt;"</span><span class="o">);</span>
        <span class="c1">// ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´</span>
        <span class="nc">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”æˆåŠŸ..."</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">MenuEntity</span><span class="o">&gt;());</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// ç¼–å†™ lua è„šæœ¬</span>
                <span class="nc">String</span> <span class="n">script</span> <span class="o">=</span> <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span><span class="o">;</span>
                <span class="c1">//åˆ é™¤é”  execute è¿™ä¸ªæ”¾ç•ªä¸­çš„å‚æ•°å¯èƒ½è¿˜éœ€è¦æä¸€æ</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultRedisScript</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;(</span><span class="n">script</span><span class="o">,</span> <span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">),</span> <span class="n">uuid</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•..."</span><span class="o">);</span>
            <span class="c1">//åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶</span>
            <span class="c1">//ä¼‘çœ ä¸€ç™¾æ¯«ç§’</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nf">getMenuJsonFormDbWithLuaLock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuById</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
<span class="c1">//        return updateMenuByIdWithLock(menu);</span>
<span class="c1">//        return updateMenuWithExpireLock(menu);</span>
        <span class="k">return</span> <span class="nf">updateMenuWithLuaLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="cm">/**
     * é—®é¢˜ï¼šé‡Šæ”¾é”æ“ä½œ ä¸¢å¤± åŸå­æ€§
     * è§£å†³æ–¹æ¡ˆ: lua è„šæœ¬
     * æ—¢ç„¶åˆ é™¤æ“ä½œå˜æˆäº†ä¸¤æ­¥ï¼Œå¤±å»äº†åŸå­æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒæ”¹æˆä¸€æ­¥å°±è¡Œå•¦å‘€ï¼Œ
     * æ­¤æ—¶å°±å¾—ç”¨ä¸Šæˆ‘ä»¬çš„ lua è„šæœ¬äº†
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">updateMenuWithRedisLock</span><span class="o">(</span><span class="nc">MenuEntity</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">Boolean</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="nc">Boolean</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”æˆåŠŸ..."</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
                <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST</span><span class="o">);</span>
                <span class="c1">// æ›´æ–°æ•°æ®åº“</span>
                <span class="n">update</span> <span class="o">=</span> <span class="n">menuMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// è·å–é”ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹çš„é”</span>
                <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">uuid</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// ç¡®å®šæ˜¯åŒä¸€æŠŠé”ï¼Œ æ‰é‡Šæ”¾é”</span>
                    <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">SET_NX_EX_MENU_LIST_LOCK</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">update</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span><span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nf">updateMenuWithRedisLock</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>å€ŸåŠ© lua è„šæœ¬æˆ‘ä»¬æˆåŠŸå°†é‡Šæ”¾é”çš„æ“ä½œå˜æˆåŸå­æ€§æ“ä½œï¼Œç¡®ä¿äº†å…¶æ­£ç¡®æ€§ã€‚</p><p>å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºåˆ†å¸ƒå¼é”çš„æ¥é¾™å»è„‰ï¼Œåº”è¯¥äº§ç”Ÿäº†ä¸€äº›å±äºè‡ªå·±çš„ç†è§£ï¼Œç°åœ¨å°±åªå‰©ä¸‹ä¸€ä¸ªé”è‡ªåŠ¨ç»­æœŸçš„é—®é¢˜æ²¡æœ‰è§£å†³äº†~</p><h3 id="35redisson-å®ç°åˆ†å¸ƒå¼é”"><span class="mr-2">3.5ã€Redisson å®ç°åˆ†å¸ƒå¼é”</span><a href="#35redisson-å®ç°åˆ†å¸ƒå¼é”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>é”éœ€è¦ç»­æœŸï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†è§£å†³åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œé”å·²ç»è¿‡æœŸï¼Œä½†ä¸šåŠ¡ä»æ²¡æ‰§è¡Œå®Œæˆçš„åœºæ™¯</strong>ã€‚</p><p>ç©¶å…¶æ ¹æœ¬å°±æ˜¯åˆ°åº•ç»™é”å¤šé•¿æ—¶é—´ç®—åˆé€‚å‘¢ï¼Ÿè¿™ç‚¹å…¶å®æ˜¯æ²¡æ³•å‡†ç¡®è¯„ä¼°çš„ã€‚</p><blockquote><p>å¦‚æœä¸æ‰“ç®—ç»™é”è‡ªåŠ¨ç»­æœŸçš„è¯ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—åº”å½“å¯¹é”çš„è¿‡æœŸæ—¶é—´ï¼Œé€‚å½“çš„å»¶é•¿ä¸€äº›ï¼Œä»¥ç¡®ä¿ä¸šåŠ¡æ­£ç¡®æ‰§è¡Œã€‚</p></blockquote><p>å¦‚æœä½ å’Œæˆ‘ä¸€æ ·æ˜¯ä¸€åJavaå¼€å‘è€…ï¼Œæƒ³è¦å»å®ç°é”è‡ªåŠ¨ç»­æœŸï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨å¸‚é¢ä¸Šå·²ç»æœ‰æˆç†Ÿçš„è½®å­<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson">Redisson</a> å•¦~</p><p>åœ¨Redissonä¸­ï¼Œæœ‰ä¸€ä¸ªè‘—åçš„<strong>çœ‹é—¨ç‹—æœºåˆ¶</strong>ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Redisson</code> æ¥å®ç°åˆ†å¸ƒå¼é”æ—¶ï¼ŒåŠ é”æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šé»˜è®¤è®¾ç½®è¿‡æœŸæ—¶é—´30sï¼Œç„¶åå½“ä¸šåŠ¡æ‰§è¡Œè¶…è¿‡10sï¼Œä¹Ÿå°±æ˜¯é”æ—¶é—´è¿˜å‰©ä¸‹ 20s æ—¶ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨ç»­æœŸã€‚</p><p><strong>å…‰è¯´ä¸ç»ƒå‡æŠŠå¼</strong>ï¼Œæˆ‘ä»¬ç›´æ¥æ¥ç”¨ä»£ç å®ç°ä¸€ä¸‹çœ‹çœ‹å§</p><p>å¼•å…¥ä¾èµ–</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.redisson<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>redisson-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.17.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
å¤åˆ¶ä»£ç 
</pre></table></code></div></div><p>é¦–å…ˆå°±æ˜¯<code class="language-plaintext highlighter-rouge">SpringBoot</code>çš„èµ·æ‰‹å¼ï¼Œç¼–å†™<code class="language-plaintext highlighter-rouge">MyRedissionConfig</code> ç±»</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyRedissonConfig</span> <span class="o">{</span>

    <span class="cm">/**
     * æ‰€æœ‰å¯¹Redissonçš„ä½¿ç”¨éƒ½æ˜¯é€šè¿‡RedissonClient
     * @return
     * @throws IOException
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">destroyMethod</span><span class="o">=</span><span class="s">"shutdown"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RedissonClient</span> <span class="nf">redissonClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//1ã€åˆ›å»ºé…ç½®</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>
        <span class="c1">// è¿æ¥å¿…é¡»è¦ä»¥ redis å¼€å¤´~ æœ‰å¯†ç å¡«å¯†ç </span>
        <span class="n">config</span><span class="o">.</span><span class="na">useSingleServer</span><span class="o">().</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"redis://IPåœ°å€:6379"</span><span class="o">).</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"000415"</span><span class="o">);</span>
        <span class="c1">//2ã€æ ¹æ®Configåˆ›å»ºå‡ºRedissonClientå®ä¾‹</span>
        <span class="c1">//Redis url should start with redis:// or rediss://</span>
        <span class="nc">RedissonClient</span> <span class="n">redissonClient</span> <span class="o">=</span> <span class="nc">Redisson</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">redissonClient</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>æˆ‘ä»¬æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸºäº<code class="language-plaintext highlighter-rouge">RedissonClient</code> æ¥å®ç°çš„ï¼Œå°†å®ƒæ³¨å…¥åˆ°Spring å®¹å™¨ä¸­ä¹‹åï¼Œåœ¨éœ€è¦çš„æ—¶å€™ç›´æ¥å¼•å…¥å³å¯ã€‚</p><p>å¦å¤– <code class="language-plaintext highlighter-rouge">Redisson</code> å®ƒå®ç°äº† JUC åŒ…ä¸‹çš„å¤§éƒ¨åˆ†é”ç›¸å…³çš„å®ç°ï¼Œå¦‚æœç†Ÿæ‚‰ JUC çš„å¼€å‘ï¼Œä½¿ç”¨è¿™æ–¹é¢ç®—æ˜¯æ²¡ä»€ä¹ˆå­¦ä¹ æˆæœ¬çš„ã€‚å¦‚JUC ä¸‹çš„è¯»å†™é”ã€ä¿¡å·é‡ç­‰ã€‚</p><p>æˆ‘ä»¬å°±æ¥ä½¿ç”¨ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">Redisson</code>ä¸­çš„è¯»å†™é”å§~</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="å·²å¤åˆ¶ï¼"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @description:
 * @author: Ning Zaichun
 * @date: 2022å¹´09æœˆ20æ—¥ 20:59
 */</span>
<span class="p">@</span><span class="nd">Service</span>
<span class="k">public</span> <span class="kd">class</span> <span class="nc">RedissonServiceImpl</span> <span class="k">implements</span> <span class="nx">IRedissonService</span> <span class="p">{</span>

    <span class="p">@</span><span class="nd">Autowired</span>
    <span class="nx">StringRedisTemplate</span> <span class="nx">stringRedisTemplate</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Autowired</span>
    <span class="k">private</span> <span class="nx">MenuMapper</span> <span class="nx">menuMapper</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">static</span> <span class="nx">final</span> <span class="nb">String</span> <span class="nx">REDISSON_MENU_LIST</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">redisson:menu:list</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nx">final</span> <span class="nb">String</span> <span class="nx">REDISSON_MENU_LIST_LOCK_VALUE</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">redisson:lock</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">@</span><span class="nd">Autowired</span>
    <span class="k">private</span> <span class="nx">RedissonClient</span> <span class="nx">redissonClient</span><span class="p">;</span>


    <span class="p">@</span><span class="nd">Override</span>
    <span class="k">public</span> <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®</span>
        <span class="nb">String</span> <span class="nx">menuJson</span> <span class="o">=</span> <span class="nx">stringRedisTemplate</span><span class="p">.</span><span class="nf">opsForValue</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="nx">REDISSON_MENU_LIST</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">menuJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>


            <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nx">menuEntityList</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parseObject</span><span class="p">(</span><span class="nx">menuJson</span><span class="p">,</span> <span class="k">new</span> <span class="nx">TypeReference</span><span class="o">&lt;</span><span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
            <span class="p">});</span>
            <span class="k">return</span> <span class="nx">menuEntityList</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span>
        <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nx">result</span> <span class="o">=</span> <span class="nf">getMenuJsonFromDbWithRedissonLock</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>



    <span class="cm">/**
     * é—®é¢˜ï¼šå…¶å®å†™æˆä¸Šé¢é‚£ç§æ¨¡æ ·ï¼Œç›¸å¯¹æ¥è¯´ï¼Œä¹Ÿèƒ½è§£å†³å¾ˆå¤šæ—¶å€™çš„é—®é¢˜äº†ï¼Œä»å¤´åˆ°å°¾çœ‹è¿‡æ¥çš„è¯ï¼Œå…¶å®ä¹Ÿèƒ½å‘ç°å°±ä¸€ä¸ªé”è‡ªåŠ¨è¿‡æœŸé—®é¢˜æ²¡æœ‰è§£å†³äº†ã€‚
     * ä½†åœ¨å®ç°è¿™ä¸ªä¹‹å‰ï¼Œæˆ‘è¿˜æ˜¯è¯´æ˜ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¯´åœ¨æ²¡æœ‰è§£å†³é”è‡ªåŠ¨è¿‡æœŸé—®é¢˜æ—¶ï¼Œå°±å·²ç»èƒ½åº”ä»˜å¤§å¤šæ•°åœºæ™¯äº†ã€‚
     * é‡ç‚¹åœ¨äºå¦‚ä½•è¯„ä¼° é”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´åˆ°åº•è®¾ç½®å¤šå°‘åˆé€‚å‘¢ï¼Ÿ
     * å…¶å®å¦‚æœå¯¹äºä¸šåŠ¡ç†è§£è¾ƒä¸ºé€å½»ï¼Œå¯¹äºè¿™ä¸€éƒ¨åˆ†çš„ä¸šåŠ¡ä»£ç æ‰§è¡Œæ—¶é—´èƒ½æœ‰ä¸€ä¸ªè¾ƒæ¸…æ™°çš„ä¼°ç®—ï¼Œç»™å®šä¸€ä¸ªåˆé€‚çš„æ—¶é—´ï¼Œåœ¨ä¸å‡ºç°æç«¯æƒ…å†µï¼ŒåŸºæœ¬éƒ½èƒ½åº”ä»˜è¿‡æ¥äº†ã€‚
     * &lt;p&gt;
     * ä½†æ˜¯å‘¢ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæ€•è¿™ä¸ªä¸‡ä¸€çš„ï¼Œä¸‡ä¸€çœŸå‡ºç°äº†ï¼Œå¯èƒ½é€ æˆçš„æŸå¤±å°±ä¸æ­¢ ä¸€ä¸‡äº†ï¼Œå“ˆå“ˆã€‚
     * è§£å†³æ–¹æ¡ˆ
     * 1ã€åœ¨å¸‚åœºä¸»æµçš„ Redission ä¸­ï¼Œé’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚è¿™ä¹Ÿæ˜¯Redissionä¸­å¸¸è¯´çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚
     * &lt;p&gt;
     * å¦‚æœéœ€è¦è‡ªå·±å®ç°çš„æ€è·¯ï¼š
     * 1ã€è¿™æ–¹é¢çš„é—®é¢˜ï¼Œä¹Ÿåšäº†ååˆ†æµ…æ˜¾çš„æ€è€ƒï¼Œæˆ‘è§‰å¾—åº”è¯¥è¿˜æ˜¯ä¾èµ–äºå®šæ—¶ä»»åŠ¡å»å®ç°ï¼Œä½†åˆ°åº•è¯¥å¦‚ä½•å®ç°è¿™ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæˆ‘è¿˜æ²¡æ³•ç»™å‡ºä¸€ä¸ªåˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚ æˆ–è®¸æˆ‘åº”è¯¥ä¼šå°è¯•ä¸€ä¸‹ã€‚
     *
     * @return
     */</span>
    <span class="k">public</span> <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nf">getMenuJsonFromDbWithRedissonLock</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span><span class="dl">"</span><span class="p">);</span>
        <span class="c1">//1ã€å åˆ†å¸ƒå¼é”ã€‚å»rediså å‘</span>
        <span class="c1">//ï¼ˆé”çš„ç²’åº¦ï¼Œè¶Šç»†è¶Šå¿«:å…·ä½“ç¼“å­˜çš„æ˜¯æŸä¸ªæ•°æ®ï¼Œ11å·å•†å“ï¼‰ product-11-lock</span>
        <span class="c1">//RLock catalogJsonLock = redissonClient.getLock("catalogJson-lock");</span>
        <span class="c1">//åˆ›å»ºè¯»é”</span>
        <span class="nx">RReadWriteLock</span> <span class="nx">readWriteLock</span> <span class="o">=</span> <span class="nx">redissonClient</span><span class="p">.</span><span class="nf">getReadWriteLock</span><span class="p">(</span><span class="nx">REDISSON_MENU_LIST_LOCK_VALUE</span><span class="p">);</span>
        <span class="nx">RLock</span> <span class="nx">rLock</span> <span class="o">=</span> <span class="nx">readWriteLock</span><span class="p">.</span><span class="nf">readLock</span><span class="p">();</span>
        <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">rLock</span><span class="p">.</span><span class="nf">lock</span><span class="p">();</span>
            <span class="nb">String</span> <span class="nx">menuJson</span> <span class="o">=</span> <span class="nx">stringRedisTemplate</span><span class="p">.</span><span class="nf">opsForValue</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="nx">REDISSON_MENU_LIST</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">menuJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span> <span class="nx">menuEntityList</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parseObject</span><span class="p">(</span><span class="nx">menuJson</span><span class="p">,</span> <span class="k">new</span> <span class="nx">TypeReference</span><span class="o">&lt;</span><span class="nx">List</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="nx">menuEntityList</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">Thread</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">InterruptedException</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
            <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">menuMapper</span><span class="p">.</span><span class="nf">selectList</span><span class="p">(</span><span class="k">new</span> <span class="nx">QueryWrapper</span><span class="o">&lt;</span><span class="nx">MenuEntity</span><span class="o">&gt;</span><span class="p">());</span>
            <span class="c1">// æ„å»ºç¼“å­˜</span>
            <span class="nx">stringRedisTemplate</span><span class="p">.</span><span class="nf">opsForValue</span><span class="p">().</span><span class="nf">set</span><span class="p">(</span><span class="nx">REDISSON_MENU_LIST</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">toJSONString</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="nx">rLock</span><span class="p">.</span><span class="nf">unlock</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="p">@</span><span class="nd">Override</span>
    <span class="k">public</span> <span class="nb">Boolean</span> <span class="nf">updateMenuById</span><span class="p">(</span><span class="nx">MenuEntity</span> <span class="nx">menu</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">updateMenuWithRedissonLock</span><span class="p">(</span><span class="nx">menu</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nb">Boolean</span> <span class="nf">updateMenuWithRedissonLock</span><span class="p">(</span><span class="nx">MenuEntity</span> <span class="nx">menu</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">RReadWriteLock</span> <span class="nx">readWriteLock</span> <span class="o">=</span> <span class="nx">redissonClient</span><span class="p">.</span><span class="nf">getReadWriteLock</span><span class="p">(</span><span class="nx">REDISSON_MENU_LIST_LOCK_VALUE</span><span class="p">);</span>
        <span class="nx">RLock</span> <span class="nx">writeLock</span> <span class="o">=</span> <span class="nx">readWriteLock</span><span class="p">.</span><span class="nf">writeLock</span><span class="p">();</span>
        <span class="nb">Boolean</span> <span class="nx">update</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">writeLock</span><span class="p">.</span><span class="nf">lock</span><span class="p">();</span>
            <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
            <span class="c1">//åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡</span>
            <span class="nx">update</span> <span class="o">=</span> <span class="nx">menuMapper</span><span class="p">.</span><span class="nf">updateById</span><span class="p">(</span><span class="nx">menu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="nx">writeLock</span><span class="p">.</span><span class="nf">unlock</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">update</span><span class="p">;</span>
    <span class="p">}</span>


<span class="p">}</span>
<span class="nx">å¤åˆ¶ä»£ç </span>
</pre></table></code></div></div><p>ä¸ºäº†ç»™å¤§å®¶æµ‹è¯•ä¸€ä¸‹å®ƒçš„è‡ªåŠ¨ç»­æœŸï¼Œæˆ‘åœ¨å®ƒç¬¬ä¸€æ¬¡æŸ¥è¯¢æ•°æ®åº“è·å–é”æ—¶ï¼Œè®©çº¿ç¨‹ç¡äº†ä¸€ä¼šï¼Œæ¥è¿›è¡Œæµ‹è¯•ã€‚</p><p>æµ‹è¯•ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/ce7352aa19b241098149ff3e5d45bb6atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/ce7352aa19b241098149ff3e5d45bb6atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="QQå½•å±20221020230329.gif" class="lazyload" data-proofer-ignore></a></p><p>Redissionçš„ä¸€äº›å…¶ä»–ç”¨æ³•ä»¥åŠå†…éƒ¨æ˜¯å¦‚ä½•å®ç°é”ç»­æœŸçš„ç­‰ç­‰ï¼Œè¿™äº›éƒ½ç•™åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å•¦ã€‚</p><h3 id="36å…³äºredissionçš„ä¸€äº›è¡¥å……"><span class="mr-2">3.6ã€å…³äºRedissionçš„ä¸€äº›è¡¥å……</span><a href="#36å…³äºredissionçš„ä¸€äº›è¡¥å……" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Redisson é»˜è®¤é”è¿‡æœŸæ—¶é—´ 30sï¼Œä¸€æ—¦è¿›è¡Œä¿®æ”¹äº†çš„è¯ï¼ŒRedissonä¼šå–æ¶ˆæ­¤é”çš„è‡ªåŠ¨ç»­æœŸæœºåˆ¶ã€‚ è¿™ä¸€æ­¥çš„æºç åœ¨ <code class="language-plaintext highlighter-rouge">RedissonLock</code>çš„<code class="language-plaintext highlighter-rouge">tryAcquireAsync</code>ä¸­ <a href="/assets/blog_res/2023-02-04-Block.assets/68d3f84e307f4e278d0235cc5fde6594tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/68d3f84e307f4e278d0235cc5fde6594tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>å¦å¤– <code class="language-plaintext highlighter-rouge">Redisson</code> è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼Œä¹Ÿè¢«å¤§å®¶ç§°ä¸ºçœ‹é—¨ç‹—æœºåˆ¶ï¼Œæ¯æ¬¡åœ¨é”è¿˜å‰©ä¸‹20ç§’çš„æ—¶å€™ï¼Œåˆä¼šè‡ªåŠ¨ç»­åˆ°30sã€‚ é»˜è®¤æ—¶é—´åœ¨ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/77a998d475014e929cdea906bd8b0675tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/77a998d475014e929cdea906bd8b0675tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/blog_res/2023-02-04-Block.assets/f74fd471ff9c4bc3a924e5998132964etplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/f74fd471ff9c4bc3a924e5998132964etplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><p>å…³äºRedissonåº•å±‚çš„ä¸€äº›æµç¨‹åˆ†æï¼Œåœ¨æ˜å¤©çš„å…³äº Redisson æºç æµ…æçš„æ–‡ç« å½“ä¸­ã€‚</p><h3 id="37æ­£ç¡®ä½¿ç”¨redisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”"><span class="mr-2">3.7ã€æ­£ç¡®ä½¿ç”¨Redisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”</span><a href="#37æ­£ç¡®ä½¿ç”¨redisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å…¶å®å°±ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ol><li>ä¸Šé”å’Œè®¾ç½®è¿‡æœŸæ—¶é—´éœ€è¦ä¿è¯åŸå­æ€§ï¼›ï¼ˆåŠ é”ï¼‰<li>åˆ¤æ–­é”IDæ˜¯å¦ä¸ºè‡ªå·±æ‰€æœ‰å’Œè§£é”éœ€è¦ä¿è¯åŸå­æ€§ ï¼ˆè§£é”ï¼‰</ol><p>ä¿è¯è¿™ä¸¤æ­¥æ‰èƒ½ä¿è¯æ­£ç¡®ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå¦å¤–åˆ™æ˜¯å¯¹äºé”çš„è¿‡æœŸæ—¶é—´éœ€è¦è¿›è¡Œä¸€ä¸ªåˆç†è¯„ä¼°ï¼Œé€‚å½“å»¶é•¿é”è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœéœ€è¦å®ç°é”è‡ªåŠ¨ç»­æœŸå¯é‡‡ç”¨ç°æœ‰çš„è½®å­ Redisson æ¥å®ç°ã€‚</p><h2 id="å››å°ç»“"><span class="mr-2">å››ã€å°ç»“</span><a href="#å››å°ç»“" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="41å›é¡¾"><span class="mr-2">4.1ã€å›é¡¾</span><a href="#41å›é¡¾" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æˆ‘ä»¬ä»æœ¬åœ°é”ä¸€ç›´è®²åˆ°åˆ†å¸ƒå¼é”ï¼Œå°†Rediså®ç°åˆ†å¸ƒå¼é”ä¸­çš„ä¸€äº›é—®é¢˜ï¼Œé€æ­¥è¿›è¡Œäº†è®²è¿°ã€‚</p><ol><li>ä»ä½¿ç”¨ç®€å•çš„ <code class="language-plaintext highlighter-rouge">Redis </code>ä¸­çš„ <code class="language-plaintext highlighter-rouge">SET KEY NX</code>å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”<li>åˆ°ä½¿ç”¨<code class="language-plaintext highlighter-rouge">SET KEY NX EX TIME </code> å‘½ä»¤è§£å†³æ­»é”é—®é¢˜<li>åˆ°å¢åŠ èº«ä»½æ ‡è¯†ï¼ˆUUIDï¼‰ è§£å†³é”è¢«å…¶ä»–äººé‡Šæ”¾é—®é¢˜<li>å†åˆ°ä½¿ç”¨ Lua è„šæœ¬ï¼Œå°†è§£é”æ“ä½œå˜æˆåŸå­æ€§æ“ä½œ<li>æœ€åè®²è¿°äº†<code class="language-plaintext highlighter-rouge">Redisson</code>å®ç°åˆ†å¸ƒå¼é”ï¼Œè§£å†³äº†é”è‡ªåŠ¨ç»­æœŸé—®é¢˜</ol><p>è¯´å®ƒéå¸¸éš¾çš„è¯ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰ï¼Œä½†æ˜¯è¿™æ˜¯ç»ˆç‚¹å—ï¼Ÿ</p><h3 id="42æ‰©å±•"><span class="mr-2">4.2ã€æ‰©å±•</span><a href="#42æ‰©å±•" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å…¶å®å¹¶ä¸æ˜¯ï¼Œä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰å‘ç°æˆ‘ä¸Šé¢æ‰€è®²è¿°çš„åˆ†å¸ƒå¼é”ï¼Œä»å§‹è‡³ç»ˆéƒ½æ˜¯å°†<code class="language-plaintext highlighter-rouge">Redis</code>å½“ä½œäº†ä¸€ä¸ªå®ä¾‹æ¥çœ‹å¾…ã€‚</p><p>ä½†åœ¨çœŸæ­£çš„ç¯å¢ƒä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Redis </code>è¿œä¸æ­¢ä¸€ä¸ªå®ä¾‹ï¼Œéƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å¤šæ ·çš„ï¼Œä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼ï¼Œä¸»ä»é›†ç¾¤ç­‰ç­‰ï¼Œé‚£ä¹ˆåœ¨è¿™äº›æƒ…å†µä¸‹ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼å»ç¼–å†™åˆ†å¸ƒå¼é”ä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿ</p><blockquote><p>ä½ è§‰å¾—å‘¢ï¼Ÿ</p></blockquote><p><strong>ç­”æ¡ˆæ˜¯åªè¦ç‰µæ‰¯åˆ°ç½‘ç»œé€šä¿¡ï¼Œé‚£ä¹ˆå¿…ç„¶å°±ä¼šäº§ç”Ÿé—®é¢˜</strong>ã€‚ ï¼ˆå¯ä»¥è¯´åœ¨åˆ†å¸ƒå¼ä¸­ï¼Œç½‘ç»œæ°¸è¿œéƒ½æ˜¯å¤„äºä¸ªä¸å¯ä¿¡çš„çŠ¶æ€ï¼‰</p><p>ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š</p><p>å‡è®¾ç°åœ¨çš„éƒ¨ç½²æ–¹å¼æ˜¯<code class="language-plaintext highlighter-rouge">ä¸»ä»é›†ç¾¤+å“¨å…µæ¨¡å¼</code>ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå½“ä¸»åº“å¼‚å¸¸å®•æœºæ—¶ï¼Œå“¨å…µå¯ä»¥å®ç°ã€Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢ã€ï¼ŒæŠŠä»åº“æå‡ä¸ºä¸»åº“ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼Œä»¥æ­¤ä¿è¯å¯ç”¨æ€§ã€‚</p><p>é‚£å‡è®¾ç°åœ¨æˆ‘ä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œåˆšè·å–åˆ°é”ï¼Œç„¶åä¸»èŠ‚ç‚¹å°±æŒ‚äº†ï¼Œæ­¤æ—¶é”è¿˜æ²¡æœ‰åŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸Šå»ï¼Œå³ä½¿ä¹‹åå®Œæˆäº†ä¸»ä»åˆ‡æ¢ï¼Œä½†æ˜¯æ­¤æ¬¡æ‰€åŠ çš„é”ä¹Ÿå·²ç»ä¸¢å¤±ã€‚</p><p>å› æ­¤åœ¨è¿™æ ·çš„åŸºç¡€ä¸Šï¼ŒRedis å®˜æ–¹ç»§è€Œåˆæ¨å‡ºäº† Redlock(çº¢é”ç®—æ³•)ã€‚</p><h2 id="äº”å…³äºçº¢é”-redlock"><span class="mr-2">äº”ã€å…³äºçº¢é” Redlock</span><a href="#äº”å…³äºçº¢é”-redlock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>å…³äºè¿™äº›é—®é¢˜ï¼ŒRedis çš„ä½œè€…ä¹Ÿæä¾›äº†ä¸€äº›è§£å†³æ–¹æ¡ˆã€Redlockã€‘ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çº¢é”ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdocs%2Freference%2Fpatterns%2Fdistributed-locks%2F">Redlock</a></p><p>çº¢é”åˆ†æ</p><hr /><ol><li>Martin Kleppmannï¼ˆè‹±å›½å‰‘æ¡¥å¤§å­¦çš„ä¸€ååˆ†å¸ƒå¼ç³»ç»Ÿç ”ç©¶å‘˜ï¼‰<a href="https://link.juejin.cn?target=http%3A%2F%2Fmartin.kleppmann.com%2F2016%2F02%2F08%2Fhow-to-do-distributed-locking.html">å…³äº Redlockçš„åˆ†æ</a><li>Redis ä½œè€… Antirez å¯¹äº<code class="language-plaintext highlighter-rouge">Martin Kleppmann</code>çš„åˆ†æå›å¤</ol><p>ä¸¤äººçš„è¾©è®ºéƒ½ååˆ†ç²¾å½©ï¼Œéå¸¸å€¼å¾—æ‹œè¯»ï¼Œä»ä¸­å¯ä»¥é¢†ç•¥åˆ°è¯¸å¤šå…³äºåˆ†å¸ƒå¼çš„æ€è€ƒã€‚</p><p>Redlock ç®€å•ä½¿ç”¨æ¥è‡ª Redis å®˜ç½‘</p><h3 id="51çº¢é”ç®—æ³•"><span class="mr-2">5.1ã€çº¢é”ç®—æ³•</span><a href="#51çº¢é”ç®—æ³•" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>åœ¨ç®—æ³•çš„åˆ†å¸ƒå¼ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ª Redis masterã€‚è¿™äº›èŠ‚ç‚¹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä½¿ç”¨å¤åˆ¶æˆ–ä»»ä½•å…¶ä»–éšå¼åè°ƒç³»ç»Ÿã€‚æˆ‘ä»¬å·²ç»æè¿°äº†å¦‚ä½•åœ¨å•ä¸ªå®ä¾‹ä¸­å®‰å…¨åœ°è·å–å’Œé‡Šæ”¾é”ã€‚æˆ‘ä»¬ç†æ‰€å½“ç„¶åœ°è®¤ä¸ºç®—æ³•ä¼šä½¿ç”¨è¿™ç§æ–¹æ³•åœ¨å•ä¸ªå®ä¾‹ä¸­è·å–å’Œé‡Šæ”¾é”ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº† N=5ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„è®¡ç®—æœºæˆ–è™šæ‹Ÿæœºä¸Šè¿è¡Œ 5 ä¸ª Redis ä¸»æœåŠ¡å™¨ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä»¥å‡ ä¹ç‹¬ç«‹çš„æ–¹å¼å‘ç”Ÿæ•…éšœã€‚</p><p>ä¸ºäº†<strong>è·å–é”ï¼Œå®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹æ“ä½œ</strong>ï¼š</p><ol><li>å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è·å–å½“å‰æ—¶é—´ã€‚<li>å®ƒå°è¯•é¡ºåºè·å–æ‰€æœ‰ N ä¸ªå®ä¾‹ä¸­çš„é”ï¼Œåœ¨æ‰€æœ‰å®ä¾‹ä¸­ä½¿ç”¨ç›¸åŒçš„é”®åå’Œéšæœºå€¼ã€‚åœ¨æ­¥éª¤ 2 ä¸­ï¼Œå½“åœ¨æ¯ä¸ªå®ä¾‹ä¸­è®¾ç½®é”æ—¶ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ä¸€ä¸ªä¸é”è‡ªåŠ¨é‡Šæ”¾æ€»æ—¶é—´ç›¸æ¯”è¾ƒå°çš„è¶…æ—¶æ¥è·å–å®ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœè‡ªåŠ¨é‡Šæ”¾æ—¶é—´ä¸º 10 ç§’ï¼Œåˆ™è¶…æ—¶å¯èƒ½åœ¨ ~ 5-50 æ¯«ç§’èŒƒå›´å†…ã€‚è¿™å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯åœ¨å°è¯•ä¸å·²å…³é—­çš„ Redis èŠ‚ç‚¹é€šä¿¡æ—¶é•¿æ—¶é—´ä¿æŒé˜»å¡ï¼šå¦‚æœä¸€ä¸ªå®ä¾‹ä¸å¯ç”¨ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¿«å°è¯•ä¸ä¸‹ä¸€ä¸ªå®ä¾‹é€šä¿¡ã€‚<li>å®¢æˆ·ç«¯é€šè¿‡ä»å½“å‰æ—¶é—´ä¸­å‡å»æ­¥éª¤ 1 ä¸­è·å¾—çš„æ—¶é—´æˆ³æ¥è®¡ç®—è·å–é”æ‰€ç”¨çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“å®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨å¤§å¤šæ•°å®ä¾‹ï¼ˆè‡³å°‘ 3 ä¸ªï¼‰ä¸­è·å–é”æ—¶ï¼Œä¸”è·å–é”çš„æ€»æ—¶é—´å°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œåˆ™è®¤ä¸ºé”å·²è¢«è·å–ã€‚<li>å¦‚æœè·å¾—äº†é”ï¼Œåˆ™å…¶æœ‰æ•ˆæ—¶é—´è¢«è®¤ä¸ºæ˜¯åˆå§‹æœ‰æ•ˆæ—¶é—´å‡å»ç»è¿‡çš„æ—¶é—´ï¼Œå¦‚æ­¥éª¤ 3 ä¸­è®¡ç®—çš„é‚£æ ·ã€‚<li>å¦‚æœå®¢æˆ·ç«¯ç”±äºæŸç§åŸå› æœªèƒ½è·å¾—é”ï¼ˆå®ƒæ— æ³•é”å®š N/2+1 ä¸ªå®ä¾‹æˆ–æœ‰æ•ˆæ—¶é—´ä¸ºè´Ÿæ•°ï¼‰ï¼Œå®ƒå°†å°è¯•è§£é”æ‰€æœ‰å®ä¾‹ï¼ˆå³ä½¿æ˜¯å®ƒè®¤ä¸ºæ²¡æœ‰çš„å®ä¾‹ï¼‰èƒ½å¤Ÿé”å®šï¼‰ã€‚</ol><h3 id="52ç®—æ³•æ˜¯å¼‚æ­¥çš„å—"><span class="mr-2">5.2ã€ç®—æ³•æ˜¯å¼‚æ­¥çš„å—ï¼Ÿ</span><a href="#52ç®—æ³•æ˜¯å¼‚æ­¥çš„å—" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>è¯¥ç®—æ³•ä¾èµ–äºè¿™æ ·ä¸€ä¸ªå‡è®¾ï¼Œå³è™½ç„¶è¿›ç¨‹ä¹‹é—´æ²¡æœ‰åŒæ­¥æ—¶é’Ÿï¼Œä½†æ¯ä¸ªè¿›ç¨‹ä¸­çš„æœ¬åœ°æ—¶é—´ä»¥å¤§è‡´ç›¸åŒçš„é€Ÿç‡æ›´æ–°ï¼Œä¸é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ç›¸æ¯”è¯¯å·®å¾ˆå°ã€‚è¿™ä¸ªå‡è®¾éå¸¸ç±»ä¼¼äºç°å®ä¸–ç•Œçš„è®¡ç®—æœºï¼šæ¯å°è®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªæœ¬åœ°æ—¶é’Ÿï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥ä¾é ä¸åŒçš„è®¡ç®—æœºæ¥è·å¾—å¾ˆå°çš„æ—¶é’Ÿæ¼‚ç§»ã€‚</p><p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½åœ°æŒ‡å®šæˆ‘ä»¬çš„äº’æ–¥è§„åˆ™ï¼šåªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯åœ¨é”æœ‰æ•ˆæ—¶é—´å†…ï¼ˆå¦‚æ­¥éª¤ 3 ä¸­è·å¾—ï¼‰å†…ç»ˆæ­¢å…¶å·¥ä½œï¼Œå‡å»ä¸€äº›æ—¶é—´ï¼ˆä»…å‡ æ¯«ç§’ä¸ºäº†è¡¥å¿è¿›ç¨‹ä¹‹é—´çš„æ—¶é’Ÿæ¼‚ç§»ï¼‰ã€‚</p><p>æœ¬æ–‡åŒ…å«æœ‰å…³éœ€è¦ç»‘å®š<em>æ—¶é’Ÿæ¼‚ç§»</em>çš„ç±»ä¼¼ç³»ç»Ÿçš„æ›´å¤šä¿¡æ¯ï¼š<a href="https://link.juejin.cn?target=http%3A%2F%2Fdl.acm.org%2Fcitation.cfm%3Fid%3D74870">ç§Ÿèµï¼šåˆ†å¸ƒå¼æ–‡ä»¶ç¼“å­˜ä¸€è‡´æ€§çš„æœ‰æ•ˆå®¹é”™æœºåˆ¶</a>ã€‚</p><h3 id="53å¤±è´¥é‡è¯•"><span class="mr-2">5.3ã€å¤±è´¥é‡è¯•</span><a href="#53å¤±è´¥é‡è¯•" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å½“å®¢æˆ·ç«¯æ— æ³•è·å–é”æ—¶ï¼Œå®ƒåº”è¯¥åœ¨éšæœºå»¶è¿Ÿåé‡è¯•ï¼Œä»¥å°è¯•ä½¿å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å°è¯•è·å–åŒä¸€èµ„æºçš„é”ï¼ˆè¿™å¯èƒ½å¯¼è‡´æ²¡æœ‰äººçš„è„‘è£‚æƒ…å†µï¼‰èƒœï¼‰ã€‚æ­¤å¤–ï¼Œå®¢æˆ·ç«¯åœ¨å¤§å¤šæ•° Redis å®ä¾‹ä¸­å°è¯•è·å–é”çš„é€Ÿåº¦è¶Šå¿«ï¼Œè£‚è„‘æ¡ä»¶çš„çª—å£å°±è¶Šå°ï¼ˆå¹¶ä¸”éœ€è¦é‡è¯•ï¼‰ï¼Œå› æ­¤ç†æƒ³æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°è¯•å°†<a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fcommands%2Fset"><code class="language-plaintext highlighter-rouge">SET</code></a>å‘½ä»¤å‘é€åˆ° N ä¸ªå®ä¾‹åŒæ—¶ä½¿ç”¨å¤šè·¯å¤ç”¨ã€‚</p><p>å€¼å¾—å¼ºè°ƒçš„æ˜¯ï¼Œå¯¹äºæœªèƒ½è·å¾—å¤§éƒ¨åˆ†é”çš„å®¢æˆ·ç«¯æ¥è¯´ï¼Œå°½å¿«é‡Šæ”¾ï¼ˆéƒ¨åˆ†ï¼‰è·å¾—çš„é”æ˜¯å¤šä¹ˆé‡è¦ï¼Œè¿™æ ·å°±æ— éœ€ç­‰å¾…å¯†é’¥åˆ°æœŸæ‰èƒ½å†æ¬¡è·å¾—é”ï¼ˆä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿç½‘ç»œåˆ†åŒºå¹¶ä¸”å®¢æˆ·ç«¯ä¸å†èƒ½å¤Ÿä¸ Redis å®ä¾‹é€šä¿¡ï¼Œåˆ™ä¼šåœ¨ç­‰å¾…å¯†é’¥åˆ°æœŸæ—¶é€ æˆå¯ç”¨æ€§æŸå¤±ï¼‰ã€‚</p><h3 id="54é‡Šæ”¾é”"><span class="mr-2">5.4ã€é‡Šæ”¾é”</span><a href="#54é‡Šæ”¾é”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>é‡Šæ”¾é”å¾ˆç®€å•ï¼Œæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦ç›¸ä¿¡å®ƒèƒ½å¤ŸæˆåŠŸé”å®šç»™å®šå®ä¾‹ï¼Œéƒ½å¯ä»¥æ‰§è¡Œã€‚</p><p>å°±æ˜¯åŒæ—¶ç»™æ‰€æœ‰çš„ Redis å®ä¾‹å‘æ¶ˆæ¯è¯´è¦é‡Šæ”¾è¿™æŠŠé”ã€‚</p><p>æˆ‘æ­¤å¤„åªæ˜¯ä¸€ä¸ªç®€å•çš„æ€è·¯ï¼Œå¦‚æœå¯¹<code class="language-plaintext highlighter-rouge">Redlock</code>å±•å¼€è¯´ï¼Œè¿™ç¯‡æ–‡ç« çš„å­—æ•°å¯èƒ½è¿˜éœ€è¦ç¿»ä¸Šä¸€å€ï¼Œè€Œä¸”æˆ‘æ„Ÿè§‰å¦‚æœæ˜¯æ²¡æœ‰å®è·µçš„å»åˆ†æï¼Œæ–‡å­—ä¼šç¨æ˜¾ç¨šå«©ï¼ŒåŒæ—¶ä¹Ÿä¼šå› ä¸ºæ— æ¡ˆä¾‹æ”¯æ’‘ï¼Œè®©å…¶çœŸå®æ€§ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><p>æƒ³ä»”ç»†äº†è§£çš„ï¼Œå¤§å®¶å¯ä»¥å¤šæ‰¾æ‰¾ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šé’ˆå¯¹ä¸¤ä½å¤§ä½¬çš„è¾©è®ºåˆ†æçš„æ–‡ç« ã€‚</p><h3 id="55è¡¥å……"><span class="mr-2">5.5ã€è¡¥å……</span><a href="#55è¡¥å……" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å…¶å®ï¼Œå¦‚æœä½ çš„åº”ç”¨åªéœ€è¦é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼é”å¹¶ä¸”å¯ä»¥æ¥å—ä¸€å®šç¨‹åº¦ä¸Šçš„æ•°æ®ä¸ä¸€è‡´æ€§ã€åƒä¹‹å‰è¯´çš„åˆšè®¾ç½®å®Œé”ï¼ŒRedisä¸­çš„ä¸»æœºå°±å®•æœºï¼Œå¯¼è‡´æ²¡æœ‰æˆåŠŸåŒæ­¥åˆ°ä»æœºï¼Œæ‰€äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´æ€§ã€‘ï¼Œé‚£ä¹ˆå®é™…ä¸Šä¹‹å‰æ‰€è®¨è®ºçš„ Redis åˆ†å¸ƒå¼é”ä¹Ÿæ˜¯è¶³å¤Ÿäº†çš„ã€‚</p><p>ä½†æ˜¯<strong>å¦‚æœä¸šåŠ¡è¦æ±‚ä¸€å®šè¦ä¿è¯åº”ç”¨ä¸­æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—ä½ å¯ä»¥è¯•ç€æ‰¾æ‰¾å…¶ä»–çš„æ–¹å¼ï¼Œæ¢æˆ<code class="language-plaintext highlighter-rouge">zookeeper</code> åŠ ä¸Šä¸€å®šçš„è¡¥å¿æœºåˆ¶å»è¯•ä¸€è¯•</strong>ã€‚æ¯•ç«ŸRedlock(çº¢é”)ä¸€æ–¹é¢å¤ªé‡äº†ï¼Œä¸æ˜¯ç‰¹åˆ«å¤§çš„é¡¹ç›®ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä¹Ÿä¸ä¼šç”¨è‡³å°‘äº”å°èµ·æ­¥çš„Rediså®ä¾‹å§ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œçœ‹äº†ä¸¤ä½å¤§ä½¬çš„è®¨è®ºï¼Œç‰¹åˆ«æç«¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½å‡ºç°é—®é¢˜çš„ã€‚</p><p>åˆšåˆšè¯´åˆ°çš„<code class="language-plaintext highlighter-rouge">Zookeeper</code> å®ç°åˆ†å¸ƒå¼é”,è™½ç„¶å®ƒä¹Ÿæœ‰é—®é¢˜ï¼Œä½†æ€»å½’å®ƒæ˜¯ä¿è¯<code class="language-plaintext highlighter-rouge">CAP</code>æœºåˆ¶ä¸­çš„<code class="language-plaintext highlighter-rouge">CP</code>çš„ï¼Œå¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»å¯¹<code class="language-plaintext highlighter-rouge">Zookeeper</code>çš„è®¿é—®è¯·æ±‚èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„æ•°æ®ï¼Œä½†ä¸ç»å¯¹ä¿è¯æœåŠ¡ä¸€å®šå¯ç”¨~ å±äºæ˜¯ç”¨æ€§èƒ½æ¢å®‰å…¨å•¦~</p><p><strong>æ€»ä¹‹ï¼Œå¦‚æœé¡¹ç›®ä¸­ä¸€å®šè¦æœ‰éå¸¸å¼ºçš„æ•°æ®ä¸€è‡´æ€§ï¼Œåœ¨é‚£ä¹ˆå¯¹äºåˆ†å¸ƒå¼é”ï¼Œä½ ä¹Ÿä¿ç•™ä¸€ä¸æ€€ç–‘ï¼Œæ¯•ç«Ÿå®ƒä¹Ÿä¸æ˜¯çœŸçš„100%å®‰å…¨çš„</strong>ã€‚</p><p>æ—¢ç„¶çœ‹åˆ°è¿™é‡Œå•¦ï¼Œæˆ‘è§‰å¾—å†çœ‹ä¸€éå¤§çº²ï¼Œåˆ¤æ–­ä¸€ä¸‹è‡ªå·±ç†è§£äº†å¤šå°‘æ˜¯éå¸¸é‡è¦çš„ï¼š</p><p><a href="/assets/blog_res/2023-02-04-Block.assets/b7481691ca674351bc655359e7b41b8atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" class="popup img-link "><img data-src="/assets/blog_res/2023-02-04-Block.assets/b7481691ca674351bc655359e7b41b8atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image" alt="image.png" class="lazyload" data-proofer-ignore></a></p><h2 id="å…³äºä»£ç "><span class="mr-2">å…³äºä»£ç </span><a href="#å…³äºä»£ç " class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>ä¸çŸ¥é“é˜…è¯»çš„å°ä¼™ä¼´ï¼Œæœ‰æœ¨æœ‰å‘ç°ä»£ç ä¸­æœ‰ä¸€ç‚¹ç‚¹å°é—®é¢˜~</p><p>åæœŸåœ¨æ£€æŸ¥æ—¶ï¼Œæ¡ˆä¾‹ä¸­çš„ä»£ç æ˜¯æœ‰ç‚¹ä¸å¤ªåˆé€‚çš„ï¼Œ<strong>åº”å½“å°†æ‰€æœ‰æ¡ˆä¾‹ä¸­çš„é€’å½’è°ƒç”¨æ–¹æ³•æ”¹ä¸ºå¾ªç¯é‡è¯•ï¼Œå¹¶é™åˆ¶é‡è¯•æ¬¡æ•°</strong>ï¼Œè€Œéä¸€ç›´é€’å½’è°ƒç”¨ã€‚</p><blockquote><p>åŸå› ï¼šå¦‚æœä¸€ç›´æ²¡æœ‰æŠ¢åˆ°é”ï¼Œé‡å¤çš„é€’å½’è°ƒç”¨æ˜¯æœ‰å¾ˆå¤§å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒçš„,è¿™æ˜¯ä¸åˆé€‚çš„ã€‚<strong>å¦å¤–å¦‚æœæ˜¯é˜…è¯»è¿‡ä¸€äº›æ¡†æ¶æºç çš„è¯ï¼Œå®ƒä»¬çš„åº•å±‚è°ƒç”¨å¤§éƒ½æ˜¯å†™ä¸ª<code class="language-plaintext highlighter-rouge">while(true)</code>æ¥è¾¾åˆ°æŸä¸ªæ–¹æ³•çš„é‡å¤è°ƒç”¨ï¼Œè€Œå¹¶éæ˜¯é€’å½’è°ƒç”¨</strong>ã€‚</p><p>æ­¤å¤„æ˜¯æˆ‘çš„ç–å¿½ï¼Œå„ä½è§è°…è§è°…ã€‚</p></blockquote><p>å¦å¤–<strong>é‡è¯•æœºåˆ¶ä¸‹å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜</strong>ï¼š</p><p><strong>å¹‚ç­‰æ€§é—®é¢˜</strong>ï¼š ï¼ˆæŸ¥è¯¢æ“ä½œå…·æœ‰å¤©ç„¶å¹‚ç­‰æ€§ï¼‰</p><p>åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨ä¼šå› ä¸ºç½‘ç»œåŸå› å‡ºç°è¶…æ—¶å¤±è´¥æƒ…å†µï¼Œè€Œé‡è¯•æœºåˆ¶ä¼šé‡å¤å¤šæ¬¡è°ƒç”¨æœåŠ¡ï¼Œä½†æ˜¯å¯¹äºè¢«è°ƒç”¨æ”¾ï¼Œå°±å¯èƒ½æ”¶åˆ°äº†å¤šæ¬¡è°ƒç”¨ã€‚å¦‚æœè¢«è°ƒç”¨æ–¹ä¸å…·æœ‰å¤©ç”Ÿçš„å¹‚ç­‰æ€§ï¼Œé‚£å°±éœ€è¦å¢åŠ æœåŠ¡è°ƒç”¨çš„åˆ¤é‡æ¨¡å—ï¼Œå¹¶å¯¹æ¯æ¬¡è°ƒç”¨éƒ½æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„idã€‚</p><p><strong>å¤§é‡è¯·æ±‚è¶…æ—¶å †ç§¯</strong>ï¼š</p><p>è¶…é«˜å¹¶å‘ä¸‹ï¼Œå¤§é‡çš„è¯·æ±‚å¦‚æœéƒ½è¿›è¡Œè¶…æ—¶é‡è¯•çš„è¯ï¼Œå¦‚æœä½ çš„é‡è¯•æ—¶é—´è®¾ç½®ä¸å®‰å…¨çš„è¯ï¼Œä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚å ç”¨æœåŠ¡å™¨çº¿ç¨‹è¿›è¡Œé‡è¯•ï¼Œè¿™æ—¶å€™æœåŠ¡å™¨çº¿ç¨‹è´Ÿè½½å°±ä¼šæš´å¢ï¼Œå¯¼è‡´æœåŠ¡å™¨å®•æœºã€‚å¯¹äºè¿™ç§è¶…é«˜å¹¶å‘ä¸‹çš„é‡è¯•è®¾è®¡ï¼Œæˆ‘ä»¬ä¸èƒ½è®©é‡è¯•æ”¾åœ¨ä¸šåŠ¡çº¿ç¨‹ï¼Œè€Œæ˜¯ç»Ÿä¸€ç”±å¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%8A%80%E6%9C%AF%E7%A7%91%E6%99%AE/'>æŠ€æœ¯ç§‘æ™®</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="post-tag no-text-decoration" >å­¦ä¹ </a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> æœ¬æ–‡ç”±ä½œè€…æŒ‰ç…§ <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> è¿›è¡Œæˆæƒ</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">åˆ†äº«</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E6%9C%AC%E5%9C%B0%E9%94%81%E5%88%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%20-%20YKFire&url=%2Fposts%2FBlock%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E6%9C%AC%E5%9C%B0%E9%94%81%E5%88%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%20-%20YKFire&u=%2Fposts%2FBlock%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FBlock%2F&text=%E6%9C%AC%E5%9C%B0%E9%94%81%E5%88%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E5%8F%98%20-%20YKFire" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="åˆ†äº«é“¾æ¥" data-title-succeed="é“¾æ¥å·²å¤åˆ¶ï¼"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">æœ€è¿‘æ›´æ–°</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ApplyProtocol2/">è®¡ç®—æœºç½‘ç»œåº”ç”¨å±‚åè®®(äºŒ)</a><li><a href="/posts/ApplyProtocol/">è®¡ç®—æœºç½‘ç»œåº”ç”¨å±‚åè®®(ä¸€)</a><li><a href="/posts/NetworkOne/">è®¡ç®—æœºç½‘ç»œå‘å±•å²(ä¸€)</a><li><a href="/posts/NetworkTwo/">è®¡ç®—æœºç½‘ç»œå‘å±•å²(äºŒ)</a><li><a href="/posts/NetworkThree/">è®¡ç®—æœºç½‘ç»œå‘å±•å²(ä¸‰)</a></ul></div><div id="access-tags"><div class="panel-heading">çƒ­é—¨æ ‡ç­¾</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ </a> <a class="post-tag" href="/tags/%E8%81%8C%E4%B8%9A%E8%A7%84%E5%88%92/">èŒä¸šè§„åˆ’</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">æ–‡ç« å†…å®¹</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>ç›¸å…³æ–‡ç« </h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/NetWorkProtocol5/"><div class="card-body"> <em class="small" data-ts="1700394840" data-df="YYYY/MM/DD" > 2023/11/19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>è®¡ç®—æœºç½‘ç»œä¼ è¾“å±‚åè®®(äº”)</h3><div class="text-muted small"><p> ä¼ è¾“å±‚åè®® è¿™æ˜¯è®¡ç®—æœºç½‘ç»œä¼ è¾“å±‚çš„ç¬¬äº”ç¯‡æ–‡ç« ã€‚ TCP æ•°æ®æµå’Œçª—å£ç®¡ç† æˆ‘ä»¬åœ¨ä¹‹å‰çš„è®²è¿°ä¸­çŸ¥é“äº†å¯ä»¥ä½¿ç”¨æ»‘åŠ¨çª—å£æ¥å®ç°æµé‡æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥ç›¸äº’æä¾›æ•°æ®æµä¿¡æ¯çš„äº¤æ¢ï¼Œæ•°æ®æµçš„ç›¸å…³ä¿¡æ¯ä¸»è¦åŒ…æ‹¬æŠ¥æ–‡æ®µåºåˆ—å·ã€ACK å·å’Œçª—å£å¤§å°ã€‚ å›¾ä¸­çš„ä¸¤ä¸ªç®­å¤´è¡¨ç¤ºæ•°æ®æµæ–¹å‘ï¼Œæ•°æ®æµæ–¹å‘ä¹Ÿå°±æ˜¯ TCP æŠ¥æ–‡æ®µçš„ä¼ è¾“æ–¹å‘ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª TCP æŠ¥æ–‡æ®µä¸­éƒ½åŒ…æ‹¬äº†åºåˆ—å·ã€ACK å’Œ...</p></div></div></a></div><div class="card"> <a href="/posts/MyFirstBlog/"><div class="card-body"> <em class="small" data-ts="1662124620" data-df="YYYY/MM/DD" > 2022/09/02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢ï¼</h3><div class="text-muted small"><p> æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢ï¼ è¿™é‡Œå¯ä»¥æ”¾ä»£ç ç‰‡æ®µå™¢ï½ //ä»£ç ç‰‡æ®µ int main(){ hello world; }</p></div></div></a></div><div class="card"> <a href="/posts/List/"><div class="card-body"> <em class="small" data-ts="1662694200" data-df="YYYY/MM/DD" > 2022/09/09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>æ•°æ®ç»“æ„--é“¾è¡¨</h3><div class="text-muted small"><p> æ•°æ®ç»“æ„â€“é“¾è¡¨ ä¸€ã€é“¾è¡¨ç®€ä»‹ ä»€ä¹ˆæ˜¯é“¾è¡¨ï¼Œé“¾è¡¨æ˜¯ä¸€ç§é€šè¿‡æŒ‡é’ˆä¸²è”åœ¨ä¸€èµ·çš„çº¿æ€§ç»“æ„ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯æ•°æ®åŸŸï¼Œä¸€ä¸ªæ˜¯æŒ‡é’ˆåŸŸï¼ˆå­˜æ”¾æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼‰ï¼Œæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆåŸŸæŒ‡å‘nullï¼ˆç©ºæŒ‡é’ˆçš„æ„æ€ï¼‰ é“¾æ¥çš„å…¥å£èŠ‚ç‚¹ç§°ä¸ºé“¾è¡¨çš„å¤´ç»“ç‚¹ä¹Ÿå°±æ˜¯head é“¾è¡¨çš„ä¸¤ç§æ“ä½œæ–¹æ³•ï¼šâ‘ ç›´æ¥ä½¿ç”¨åŸæ¥çš„é“¾è¡¨è¿›è¡Œæ“ä½œ â‘¡è®¾ç½®ä¸€ä¸ªè™šæ‹Ÿå¤´ç»“ç‚¹è¿›è¡Œæ“ä½œ ä¸€èˆ¬è®¾ç½®ä¸€ä¸ªè™šæ‹Ÿå¤´ç»“ç‚¹æ¥æ“ä½œ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Debug/" class="btn btn-outline-primary" prompt="ä¸Šä¸€ç¯‡"><p>é«˜æ•ˆDebugï¼Œæ’æŸ¥é—®é¢˜æ•ˆç‡å¤§å¤§æå‡</p></a> <a href="/posts/RPC/" class="btn btn-outline-primary" prompt="ä¸‹ä¸€ç¯‡"><p>ä»€ä¹ˆæ˜¯RPCåŠå…¶è°ƒç”¨åŸç†</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">çƒ­é—¨æ ‡ç­¾</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ </a> <a class="post-tag" href="/tags/%E8%81%8C%E4%B8%9A%E8%A7%84%E5%88%92/">èŒä¸šè§„åˆ’</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> Â© 2024 <a href="https://twitter.com/username">YKFire</a>. <span data-toggle="tooltip" data-placement="top" title="é™¤éå¦æœ‰è¯´æ˜ï¼Œæœ¬ç½‘ç«™ä¸Šçš„åšå®¢æ–‡ç« å‡ç”±ä½œè€…æŒ‰ç…§çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™… (CC BY 4.0) è®¸å¯åè®®è¿›è¡Œæˆæƒã€‚">ä¿ç•™éƒ¨åˆ†æƒåˆ©ã€‚</span></p></div><div class="footer-right"><p class="mb-0">æœ¬ç«™ç”± <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> ç”Ÿæˆï¼Œé‡‡ç”¨ <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> ä¸»é¢˜ã€‚</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG â€º <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">æœç´¢ç»“æœä¸ºç©º</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>

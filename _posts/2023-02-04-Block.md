---
title: æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜
date: 2023-02-04 17:44:00 +0800
categories: [æŠ€æœ¯ç§‘æ™®]
tags: [å­¦ä¹ ]
pin: true
author: YKFire

toc: true
comments: true

math: false
mermaid: true

typora-root-url: ../../YKFire.github.io

---

# æœ¬åœ°é”åˆ°åˆ†å¸ƒå¼é”çš„æ¼”å˜

## ä¸€ã€æœ¬åœ°é”

### 1.1ã€æœ¬åœ°é”çš„ä½¿ç”¨

æœ¬åœ°é”ä¸»è¦æ˜¯é’ˆå¯¹å•ä½“æœåŠ¡è€Œè¨€çš„ï¼Œé”çš„éƒ½æ˜¯å•ä½“åº”ç”¨å†…çš„è¿›ç¨‹ã€‚

åƒä¹‹å‰åœ¨å•æœºæƒ…å†µä¸‹å‡ºç°çš„è¯»å†™å¹¶å‘æƒ…å†µã€‚å› ä¸ºå¹¶å‘æƒ…å†µä¸‹ç½‘ç»œå‡ºç°é—®é¢˜æˆ–æ˜¯å‡ºç°å…¶ä»–å¡é¡¿é—®é¢˜ï¼Œå¯¼è‡´æ‰§è¡Œé¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œäº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´æ€§ã€‚å¦‚ä¸‹å›¾ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/34fe6595111c48459144b4dc83b72e64tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

è§£å†³å¹¶å‘æœ€å¿«çš„æ–¹å¼å°±æ˜¯åŠ é”å—ï¼Œæˆ‘ä»¬ä¹Ÿå°±ç»™å®ƒæ¥æŠŠé”å§ï¼ŒJavaä¸­çš„é”æ˜¯æœ‰è›®å¤šçš„ï¼Œæˆ‘è¿™é‡Œä¸è¿‡å¤šè®¨è®ºå•¦ï¼ˆsynchronizedã€JUCï¼‰ç­‰ç­‰ã€‚

æˆ‘æ¡ˆä¾‹ä¸­æ‰€ä½¿ç”¨çš„æ˜¯ JUC åŒ…ä¸‹çš„è¯»å†™é”`ReentrantReadWriteLock` ï¼Œæ¯•ç«Ÿä¸èƒ½è®©é”ç›´æ¥é™åˆ¶äº†Redis çš„å‘æŒ¥~ï¼Œè¯»å†™é”æ˜¯è¯»å¹¶å‘ï¼Œå†™ç‹¬å çš„æ¨¡å¼ã€‚

å¢åŠ è¯»å†™é”ä¹‹åçš„æµç¨‹å›¾å¦‚ä¸‹ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/131d63f48cd243e08bd1c4ded96f949btplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šåŠ ä¸Šé”ä¹‹åçš„æµç¨‹ï¼‰

æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
@Service
public class RedisCacheServiceImpl implements IRedisCacheService {


    @Autowired
    private MenuMapper menuMapper;

    @Autowired
    StringRedisTemplate redisTemplate;

    private static final String REDIS_MENU_CACHE_KEY = "menu:list";

    private ReentrantReadWriteLock readWriteLock = new ReentrantReadWriteLock();


    @Override
    public List<MenuEntity> getList() {
        //1ã€ä»ç¼“å­˜ä¸­è·å–
        String menuJson = redisTemplate.opsForValue().get(REDIS_MENU_CACHE_KEY);
        if (!StringUtils.isEmpty(menuJson)) {
            System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–");
            //2ã€ç¼“å­˜ä¸ä¸ºç©ºç›´æ¥è¿”å›
            List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
            });
            return menuEntityList;
        }
        //3ã€æŸ¥è¯¢æ•°æ®åº“
        //ä¸åŠ é”æƒ…å†µä¸‹
        // List<MenuEntity> noLockList = getMenuJsonFormDb();
        // åŠ é”æƒ…å†µä¸‹
        List<MenuEntity> menuEntityList = getMenuJsonFormDbWithReentrantReadWriteLock();
        return menuEntityList;
    }

    public List<MenuEntity> getMenuJsonFormDb() {
        System.out.println("ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==>");
        //ç¼“å­˜ä¸ºç©ºï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜
        List<MenuEntity> result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
        //4ã€å°†æŸ¥è¯¢çš„ç»“æœï¼Œé‡æ–°æ”¾å…¥ç¼“å­˜ä¸­
        redisTemplate.opsForValue().set(REDIS_MENU_CACHE_KEY, JSON.toJSONString(result));
        return result;
    }

    public List<MenuEntity> getMenuJsonFormDbWithReentrantReadWriteLock() {
        List<MenuEntity> result = null;
        System.out.println("ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==>");
        // synchronized æ˜¯åŒæ­¥é”ï¼Œæ‰€ä»¥å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œä¼šé˜»å¡å¼ç­‰å¾…
        ReentrantReadWriteLock.ReadLock readLock = readWriteLock.readLock();
        readLock.lock();
        try {
            String menuJson = redisTemplate.opsForValue().get(REDIS_MENU_CACHE_KEY);
            //åŠ é”æˆåŠŸ... å†æ¬¡åˆ¤æ–­ç¼“å­˜æ˜¯å¦ä¸ºç©º
            if (!StringUtils.isEmpty(menuJson)) {
                System.out.println("ç¼“å­˜ä¸­ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–");
                //2ã€ç¼“å­˜ä¸ä¸ºç©ºç›´æ¥è¿”å›
                List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
                });
                return menuEntityList;
            }
            //ç¼“å­˜ä¸ºç©ºï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜
            result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
            //4ã€å°†æŸ¥è¯¢çš„ç»“æœï¼Œé‡æ–°æ”¾å…¥ç¼“å­˜ä¸­
            redisTemplate.opsForValue().set(REDIS_MENU_CACHE_KEY, JSON.toJSONString(result));
            return result;
        } finally {
            readLock.unlock();
        }
    }


    @Override
    public Boolean updateMenuById(MenuEntity menu) {
        //return updateMenuByIdNoWithLock(menu);
        return updateMenuByIdWithReentrantReadWriteLock(menu);
    }


    public Boolean updateMenuByIdNoWithLock(MenuEntity menu) {
        // 1ã€åˆ é™¤ç¼“å­˜
        redisTemplate.delete(REDIS_MENU_CACHE_KEY);
        System.out.println("æ¸…ç©ºå•æœºRedisç¼“å­˜");
        // 2ã€æ›´æ–°æ•°æ®åº“
        return menuMapper.updateById(menu) > 0;
    }

    public Boolean updateMenuByIdWithReentrantReadWriteLock(MenuEntity menu) {
        ReentrantReadWriteLock.WriteLock writeLock = readWriteLock.writeLock();
        writeLock.lock();
        try {
            // 1ã€åˆ é™¤ç¼“å­˜
            System.out.println("æ¸…é™¤ç¼“å­˜");
            redisTemplate.delete(REDIS_MENU_CACHE_KEY);
            // 2ã€æ›´æ–°æ•°æ®åº“
            return menuMapper.updateById(menu) > 0;
        }finally {
            writeLock.unlock();
        }
    }
}
å¤åˆ¶ä»£ç 
```

å…·ä½“è¿˜éœ€å¤§å®¶å»äº†è§£~

æˆ‘è¿™é‡ŒåŠ çš„ JUC ä¸‹çš„è¯»å†™é”ï¼ŒåŸæœ¬æˆ‘æƒ³çš„æ˜¯å¼„çš„JUCçš„é”

### 1.2ã€æœ¬åœ°é”å­˜åœ¨çš„é—®é¢˜

**çœ‹èµ·æ¥æœ¬åœ°é”æ²¡æœ‰å¹¶å‘é—®é¢˜ï¼Œä¸ç®¡æœ‰å¤šå°‘è¯·æ±‚ä¸€èµ·è¿›æ¥ï¼Œéƒ½è¦å»äº‰å–é‚£å”¯ä¸€çš„ä¸€æŠŠé”ï¼ŒæŠ¢åˆ°äº†æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œä¸šåŠ¡**ã€‚

å•ä½“é¡¹ç›®ä¸­ï¼Œæ¯æŠŠé”é”çš„å°±æ˜¯å½“å‰æœåŠ¡ä¸­çš„å½“å‰çº¿ç¨‹çš„è¯·æ±‚ã€‚

![image.png](/assets/blog_res/2023-02-04-Block.assets/d3a289127c194b24ba08504911b718f2tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šå•ä½“æœåŠ¡æ—¶ï¼‰

ä½†æ˜¯å½“æœåŠ¡éœ€è¦è¿›ä¸€æ­¥æ‰©å±•æ—¶ï¼Œå°±ä¼šéšä¹‹äº§ç”Ÿå‡ºä¸€äº›é—®é¢˜ã€‚

å¤šæœåŠ¡å¹¶å‘æ—¶ï¼Œå¦‚æœè¿˜æ˜¯åªç»™å½“å‰çº¿ç¨‹åŠ é”ï¼Œ**å¤šä¸ªç”¨æˆ·ä¸€èµ·å°è¯•è·å–é”æ—¶ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶è·å–åˆ°é”ï¼Œå¯¼è‡´å‡ºç°é—®**é¢˜ã€‚

å¦‚ä¸‹å›¾ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/3c161c6b725349df811ea1a72c7fa035tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image) **æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å•ç‹¬çš„ï¼ŒåŠ é”æ“ä½œä¹Ÿåªæ˜¯ç»™è‡ªå·±çš„ï¼Œå¤§å®¶ä¸èƒ½å…±äº«**ï¼Œé‚£ä¹ˆå®é™…ä¸Šåœ¨é«˜å¹¶å‘çš„æ—¶å€™ï¼Œæ˜¯æ ¹æœ¬æ²¡æ•ˆæœçš„ã€‚

æˆ‘1å·æœåŠ¡æŠ¢åˆ°äº†é”ï¼Œè¿˜æ²¡ç­‰åˆ°é‡Šæ”¾ï¼Œ2å·æœåŠ¡åˆè·å–åˆ°äº†é”ï¼Œæ¥ç€3å·ã€4å·ç­‰ç­‰ï¼Œå¤§å®¶éƒ½å¯ä»¥æ“ä½œæ•°æ®åº“ï¼Œè¿™æŠŠé”ä¹Ÿå°±å¤±å»äº†å®ƒè¯¥æœ‰çš„ä½œç”¨ã€‚

å› æ­¤å°±è¿›ä¸€æ­¥å‡ºç°äº†åˆ†å¸ƒå¼é”ï¼Œæ¥ä¸‹æ¥ç»§ç»­çœ‹å§ã€‚

## äºŒã€åˆ†å¸ƒå¼é”çš„ä»‹ç»

**æœ¬åœ°é”å¤±æ•ˆæ˜¯å› ä¸ºæ— æ³•é”ä½å„ä¸ªåº”ç”¨çš„è¯»å†™è¯·æ±‚ï¼Œå¤±æ•ˆçš„æ ¹æœ¬åŸå› å°±æ˜¯å…¶ä»–çš„æœåŠ¡æ— æ³•æ„ŸçŸ¥åˆ°æ˜¯å¦å·²ç»æœ‰è¯·æ±‚ä¸Šé”äº†ï¼Œå³æ— æ³•å…±äº«é”ä¿¡æ¯**ã€‚

åˆ†å¸ƒå¼é”ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å°†åŠ é”çš„è¿™ä¸€ä¸ªæ“ä½œï¼Œå•ç‹¬çš„æŠ½å–å‡ºæ¥äº†ï¼Œè®©æ¯ä¸ªæœåŠ¡éƒ½èƒ½æ„ŸçŸ¥åˆ°ã€‚

ä¹‹å‰å°±è¯´äº†ï¼Œè½¯ä»¶æ¶æ„è®¾è®¡ä¸­ï¼Œ"**æ²¡æœ‰ä»€ä¹ˆæ˜¯åŠ ä¸€å±‚è§£å†³ä¸äº†çš„ï¼Œå¦‚æœåŠ ä¸€å±‚ä¸è¡Œå°±å†åŠ ä¸€å±‚**"ã€‚

è¿™é‡Œå…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ç¢°å·§è¿™ä¸€å±‚å¯ä»¥åœ¨Redisä¸­å®ç°ç½¢äº†ï¼Œçœ‹èµ·æ¥å€’æ˜¯æ²¡æœ‰å¤šåŠ ä¸€å±‚ï¼Œä½†å¦‚æœæ˜¯ç”¨`Zookeeper` æˆ–è€…å…¶ä»–æ–¹å¼æ¥å®ç°ï¼Œä½ ä¼šå‘ç°æ¶æ„ä¸­ä¼šå¤šä¸€å±‚æ»´ã€‚

![image.png](/assets/blog_res/2023-02-04-Block.assets/5b3032e9159d4a49981cddc77bf7338ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

å…¶å®ç†è§£æ€æƒ³å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§çš„ï¼Œ

- Redis å®ç°åˆ†å¸ƒå¼é”
- Zookeeper å®ç°åˆ†å¸ƒå¼é”
- MySQL ä¸“é—¨ç”¨ä¸€å¼ è¡¨æ¥è®°å½•ä¿¡æ¯ï¼Œå®ç°åˆ†å¸ƒå¼é”ï¼Œä¹Ÿæ˜¯å¸¸è¯´çš„åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ã€‚

æ‰€è°“çš„åŠ é”ï¼Œå…¶æœ¬è´¨ä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªä¿¡å·é‡æ˜¯å¦å­˜åœ¨ç½¢äº†ï¼Œåˆ†å¸ƒå¼ä¹Ÿå°±æ˜¯æŠŠè¿™ä¸ªä¿¡å·é‡ä»æœ¬åœ°çº¿ç¨‹ä¸­ï¼Œç§»æ¤åˆ°äº†Redisä¸­å­˜å‚¨ï¼Œè®©æ‰€æœ‰æœåŠ¡ä¸­çš„è¯·æ±‚éƒ½èƒ½å…±äº«ä¸€æŠŠé”ã€‚çŸ¥é“æ€æƒ³åï¼Œå®ç°æ–¹å¼å¹¶ä¸å±€é™ï¼Œå¤§å®¶ä¹Ÿä¸è¦å±€é™äº†è‡ªå·±ï¼Œéƒ½å·²ç»ç«™åœ¨å·¨äººè‚©è†€ä¸Šï¼Œå°±è¦æƒ³çš„æ›´å¤šä¸€äº›~

æˆ‘é‡‡ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œä¸»è¦åŸå› ï¼š

1. Redis æ˜¯åŸºäºå†…å­˜æ“ä½œçš„æ•°æ®åº“ï¼Œé€Ÿåº¦å¿«ï¼›
2. å¸‚åœºä¸»æµçš„æ•°æ®åº“ï¼Œæ‹¥æœ‰è¾ƒå¤šçš„å‚è€ƒèµ„æ–™ï¼›
3. Redis ç¤¾åŒºå¼€å‘è€…æ´»è·ƒï¼Œå¹¶ä¸” Redis å¯¹åˆ†å¸ƒå¼é”æœ‰è¾ƒå¥½çš„æ”¯æŒï¼›

------

ä»Šå¤©æ‰€è®¨è®ºçš„ï¼Œä¸»è¦å°±æ˜¯é’ˆå¯¹äºä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œæµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/1ba6f176c60e4bbb83f7c4d40a64313ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

ï¼ˆå›¾ç‰‡è¯´æ˜ï¼šæ­¤å›¾ä¸ºè·å–é”çš„å¤§è‡´æµç¨‹ï¼Œå…¶ä¹‹åçš„æ„å»ºç¼“å­˜ã€é‡Šæ”¾é”ç­‰æœªåœ¨å›¾ä¸Šæ‰€æ ‡æ˜ï¼‰

è™½ç„¶ä¸¤ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ•°æ®åº“ä»£ç å‰ï¼Œéƒ½éœ€è¦å…ˆè·å–åˆ°è¯»é”æˆ–è€…å†™é”ï¼Œä»¥ç¡®ä¿å¹¶å‘æ—¶æ‰§è¡Œçš„æ­£ç¡®æ€§~

æ¥ä¸‹æ¥å°±æ˜¯è¯´åˆ†å¸ƒå¼é”çš„å®ç°å•¦~

## ä¸‰ã€åˆ†å¸ƒå¼é”çš„å®ç°

åœ¨ä¸Šä¸€å°èŠ‚å°±å·²è¯´åˆ†å¸ƒå¼é”çš„å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œå¤§çš„èŒƒå›´ä¸­æœ‰ Redisã€Zookeeperã€MySQLç­‰å®ç°æ–¹å¼ï¼Œæˆ‘å…·ä½“è®²çš„æ˜¯ä»¥ Redis çš„å®ç°ã€‚

è®²è§£è¿‡ç¨‹ä¹Ÿæ˜¯é€æ­¥æ·±å…¥ï¼Œé€æ­¥æ¼”è¿›ï¼Œå¹¶éæ˜¯ç›´æ¥ä¸¢å‡ºå®ç°ä»£ç ï¼Œé’ˆå¯¹ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œä¸ºä»€ä¹ˆæœ€ç»ˆæ˜¯è¿™æ ·ï¼Œè®©å¤§å®¶æœ‰ä¸€ä¸ªäº†è§£è¿‡ç¨‹ã€‚

é”çš„ç¬¬ä¸€ä¸ªè¦æ±‚å°±æ˜¯è¦èƒ½åšåˆ°äº’æ–¥ï¼Œè€Œåœ¨Redisä¸­æœ€å®¹æ˜“æƒ³åˆ°ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„ï¼Œæ— ç–‘å°±æ˜¯ `setnx`  å‘½ä»¤ã€‚

æˆ‘ä»¬å°±ä»¥ `setnx`æŠ›ç –å¼•ç‰ï¼Œæ¥å¯¹åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œåšä¸€ä¸ªé€æ­¥æ¼”è¿›çš„è®¨è®ºã€‚

### 3.1ã€setnx

`Redis Setnx`ï¼ˆ **SET IF  Not EXists** ï¼‰å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸º key è®¾ç½®æŒ‡å®šçš„å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ç­‰åŒ [SET](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fset.html) å‘½ä»¤ã€‚å½“ `key`å­˜åœ¨æ—¶ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚

è¿”å›å€¼

- å¦‚æœkeyè®¾ç½®æˆåŠŸäº†ï¼Œåˆ™è¿”å›`1`
- å¦‚æœkeyè®¾ç½®å¤±è´¥äº†ï¼Œåˆ™è¿”å›`0`

```sql
redis> SETNX mykey "Hello"
(integer) 1
redis> SETNX mykey "World"
(integer) 0
redis> GET mykey
"Hello"
å¤åˆ¶ä»£ç 
```

è½¬æ¢åˆ°åŠ é”çš„æµç¨‹ä¸­å°±æ˜¯ï¼Œå½“è¯»è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œå…ˆç”¨`setnx`å‘½ä»¤å¾€ Redis ä¸­è®¾ç½®ä¸€ä¸ªå€¼ï¼Œè¿”å›`1`åˆ™æ˜¯åŠ é”æˆåŠŸäº†ï¼Œè¿”å›`0`åˆ™æ˜¯åŠ é”å¤±è´¥äº†ã€‚

å¦‚ä½•é‡Šæ”¾é”å‘¢ï¼Ÿ

`setnx`å…¶æœ¬è´¨å’Œ`set`å‘½ä»¤å…¶å®å·®ä¸å¤šï¼Œéƒ½æ˜¯å¾€ Redis ä¸­è®¾ç½®ä¸€ä¸ªå€¼ï¼Œé‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤è¿™ä¸ª`key`å€¼ï¼Œä½¿ç”¨ `del key` å‘½ä»¤åˆ é™¤å³ç­‰äºé‡Šæ”¾é”~

æ€è·¯ğŸ‘¨â€ğŸ«ï¼š

- è¯»è¯·æ±‚è¿‡æ¥ï¼Œåˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå­˜åœ¨ç«‹é©¬è¿”å›ï¼Œä¸å­˜åœ¨åˆ™å¾€ä¸‹èµ°ã€‚
- è¯»è¯·æ±‚å°è¯•è·å–è¯»é”ï¼Œä½¿ç”¨ `setnx` å‘½ä»¤
- å‘Redisä¸­å°è¯•setä¸€ä¸ªå€¼ï¼Œå½“ä¸”ä»…å½“å€¼ä¸å­˜åœ¨æ—¶è®¾ç½®æˆåŠŸã€‚
- è®¾ç½®æˆåŠŸè¿”å› 1ï¼Œå¦åˆ™è¿”å› 0
- è·å–æˆåŠŸåï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œé‡æ–°æ„å»ºç¼“å­˜ã€‚

ä»£ç æ¡ˆä¾‹å®ç°ï¼š

```java
@Service
public class SetNxExLockServiceImpl implements ISetNxExLockService {

    @Autowired
    StringRedisTemplate stringRedisTemplate;

    @Autowired
    private MenuMapper menuMapper;

    private static final String SET_NX_EX_MENU_LIST = "set:nx:ex:menu:list";
    private static final String SET_NX_EX_MENU_LIST_LOCK = "set:nx:ex:menu:list:lock";
    private static final String SET_NX_EX_MENU_LIST_LOCK_VALUE = "lock";

    @Override
    public List<MenuEntity> getList() {
        // åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®
        String menuJson = stringRedisTemplate.opsForValue().get(SET_NX_EX_MENU_LIST);
        if (menuJson != null) {
            System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®");
            List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
            });
            return menuEntityList;
        }

        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
        List<MenuEntity> result = getMenuJsonFormDbWithLock();

        return result;
    }

    /**
     * é—®é¢˜ï¼šæ­»é”é—®é¢˜ï¼Œ å¦‚æœåœ¨æ‰§è¡Œè§£é”æ“ä½œä¹‹å‰ï¼ŒæœåŠ¡çªç„¶å®•æœºï¼Œé‚£ä¹ˆé”å°±æ°¸è¿œæ— æ³•è¢«é‡Šæ”¾ï¼Œä»è€Œé€ æˆæ­»é”é—®é¢˜
     * è§£å†³æ–¹æ¡ˆ: å› ä¸º Redis çš„æ›´æ–°ï¼Œç°åœ¨ setIfAbsent æ”¯æŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè€Œæ— éœ€åˆ†æˆä¸¤æ­¥æ“ä½œã€‚
     *
     * @return
     */
    public List<MenuEntity> getMenuJsonFormDbWithLock() {
        List<MenuEntity> result = null;
        System.out.println("ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==>");
        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, SET_NX_EX_MENU_LIST_LOCK_VALUE);
        if (lock) {
            System.out.println("è·å–åˆ†å¸ƒå¼é”æˆåŠŸ...");
            try {
                //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
                result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
                stringRedisTemplate.opsForValue().set(SET_NX_EX_MENU_LIST, JSON.toJSONString(result));
            } finally {
                // é‡Šæ”¾é”
                stringRedisTemplate.delete(SET_NX_EX_MENU_LIST_LOCK);
            }
            return result;
        } else {
            System.out.println("è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•...");
            //åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶
            //ä¼‘çœ ä¸€ç™¾æ¯«ç§’
            try {
                TimeUnit.MILLISECONDS.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            // æ‰‹åŠ¨å®ç°è‡ªæ—‹
            return getMenuJsonFormDbWithLock();
        }
    }

        // æ›´æ–°æ“ä½œ
        @Override
        public Boolean updateMenuById(MenuEntity menu) {
            return updateMenuByIdWithLock(menu);
        }
        public Boolean updateMenuByIdWithLock(MenuEntity menu) {
            Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, SET_NX_EX_MENU_LIST_LOCK_VALUE);
            Boolean update = false;
            if (lock) {
                System.out.println("æ›´æ–°æ“ä½œï¼šè·å–åˆ†å¸ƒå¼é”æˆåŠŸ===>");
                // åˆ é™¤ç¼“å­˜
                try {
                    stringRedisTemplate.delete(SET_NX_EX_MENU_LIST);
                    // æ›´æ–°æ•°æ®åº“
                    update = menuMapper.updateById(menu) > 0;
                } finally {
                    // ä¸€å®šè¦é‡Šæ”¾é”ï¼Œä»¥å…é€ æˆæ­»é”é—®é¢˜
                    stringRedisTemplate.delete(SET_NX_EX_MENU_LIST_LOCK);
                }
                return update;
            }else{
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                return updateMenuByIdWithLock(menu);
            }
        }

}
å¤åˆ¶ä»£ç 
```

`æ³¨æ„`ï¼šä»£ç ä¸­æœ‰åŠ é”æ“ä½œï¼Œå°±ä¸€å®šè¦è®°å¾—å°†è§£é”æ“ä½œæ”¾åˆ°äº†finallyæ‰§è¡Œï¼Œä»¥ä¿è¯åœ¨ä»£ç å±‚é¢ä¸ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚

ä½ è§‰å¾—ä¸Šé¢çš„æ¡ˆä¾‹å­˜åœ¨ä»€ä¹ˆæ ·çš„é—®é¢˜å—ï¼Ÿ

å’‹ä¸€çœ‹ï¼Œä¸Šé¢çš„å¥½åƒç¡®å®å®ç°äº†åˆ†å¸ƒå¼é”ï¼Œ`setIfAbsent()`æ–¹æ³•å®ç°äº†é”çš„äº’æ–¥æ€§ï¼ŒRedis ä¹Ÿè®©é”å¾—åˆ°å…±äº«ï¼Œä½†æ˜¯çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ

**æ€è€ƒ**ğŸ§ï¼š

å¦‚æœæŸä¸ªæ—¶åˆ»ä»£ç æ‰§è¡Œåˆ°é‡Šæ”¾é”çš„é‚£ä¸€æ­¥ï¼ŒæœåŠ¡çªç„¶æŒ‚äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå°±æ„å‘³ç€é”é‡Šæ”¾å¤±è´¥äº†å‹’ï¼Œé‚£ä¹ˆä¹Ÿå°±é€ æˆäº†æœ€å¤§çš„é—®é¢˜**æ­»é”**ï¼Œå› ä¸ºæ²¡æœ‰è§£é”æ“ä½œï¼Œé”ä¹Ÿå°±å°†æ— æ³•è¢«é‡Šæ”¾ã€‚

é‚£è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

æœ€ä½³çš„æ–¹å¼å°±æ˜¯ç»™é”**è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´**~

### 3.2ã€è§£å†³æ­»é”é—®é¢˜

æœ€å®¹æ˜“æƒ³åˆ°ä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç»™è¿™ä¸ª**åˆ†å¸ƒå¼é”åŠ ä¸ªè¿‡æœŸæ—¶é—´**ï¼Œæ¯”å¦‚`3sã€5s`ä¹‹ç±»ï¼Œä½¿ç”¨`EXPIRE`è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´

ä½†å¦‚æœæƒ³åˆ°çš„æ˜¯è¿™ç§ï¼š

```bash
redis> SETNX mykey "Hello"
(integer) 1
redis> EXPIRE mykey 10
(integer) 1
redis> SETNX mykey "World"
(integer) 0
redis> TTL mykey
(integer) 8
redis> GET mykey
"Hello"
å¤åˆ¶ä»£ç 
```

å¦‚æœæ˜¯è¿™ä¹ˆå®ç°çš„è¯ï¼Œå’±ä»¬å°±è¿˜æ˜¯å¯¹äº Redis äº†è§£å¤ªå°‘äº†ã€‚

é¦–å…ˆè¯´è¯´è¿™æ ·æ“ä½œä¼šå‡ºç°çš„é—®é¢˜ï¼š

1. æˆ‘æˆåŠŸè®¾ç½®äº†`key`ï¼Œä½†æ˜¯è¿˜æ²¡æ‰§è¡Œåˆ°è®¾ç½®æ—¶é—´é‚£ä¸€æ­¥ï¼Œåº”ç”¨ç¨‹åºçªç„¶æŒ‚äº†ï¼Œå¯¼è‡´æ­»é”é—®é¢˜äº§ç”Ÿã€‚
2. æˆ–è€…æ˜¯æˆåŠŸè®¾ç½®äº† `key` åï¼ŒRedis æœåŠ¡çªç„¶å´©æºƒäº†ï¼Œä¸å¹²æ´»äº†ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†åé¢çš„`EXPIRE`æ— æ³•æ‰§è¡ŒæˆåŠŸï¼ŒåŒæ ·ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚

ã€**é‡ç‚¹**ã€‘ï¼šå› ä¸ºåŠ é”å’Œè®¾ç½®æ—¶é—´ä¸æ˜¯**ä¸€ä¸ªåŸå­æ€§æ“ä½œ**

æ€ä¹ˆæ‰èƒ½å°†åŠ é”å’Œè®¾ç½®é”æ—¶é—´å˜æˆä¸€ä¸ªåŸå­æ“ä½œå‘¢ï¼Ÿ

å…¶å®è¿™ä¸€æ­¥Rediså·²ç»å¸®æˆ‘ä»¬åšå¥½å•¦~

Redis ä¸­çš„`set`å‘½ä»¤æ˜¯å¯ä»¥æ·»åŠ å‚æ•°çš„ï¼Œä¸€æ¡setå‘½ä»¤å³å¯å®ç°`SETNX+EXPIRE`æ•ˆæœï¼Œå°†åŠ é”å’Œè®¾ç½®æ—¶é—´å˜æˆä¸€ä¸ªåŸå­æ€§æ“ä½œï¼Œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ã€‚

å®Œæ•´å‘½ä»¤å‚æ•°ï¼š[æ–‡æ¡£é“¾æ¥](https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fcommands%2Fset%2F)

> SET key value [EX seconds|PX milliseconds|KEEPTTL] [NX|XX] [GET]

- `EX` *seconds* â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’
- `PX` *milliseconds* â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’
- `NX` â€“ åªæœ‰é”®keyä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼
- `XX` â€“ åªæœ‰é”®keyå­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼
- `KEEPTTL` -- è·å– key çš„è¿‡æœŸæ—¶é—´
- [GET](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fget.html) -- è¿”å› key å­˜å‚¨çš„å€¼ï¼Œå¦‚æœ key ä¸å­˜åœ¨è¿”å›ç©º

**æ³¨æ„:** ç”±äº`SET`å‘½ä»¤åŠ ä¸Šé€‰é¡¹å·²ç»å¯ä»¥å®Œå…¨å–ä»£`SETNX`, [SETEX](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fsetex.html), [PSETEX](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fpsetex.html), [GETSET](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fgetset.html),çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ï¼Œrediså¯èƒ½ä¼šä¸æ¨èä½¿ç”¨å¹¶ä¸”æœ€ç»ˆæŠ›å¼ƒè¿™å‡ ä¸ªå‘½ä»¤ã€‚

è¿”å›å€¼

[å­—ç¬¦ä¸²](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Ftopics%2Fprotocol.html%23simple-string-reply): å¦‚æœ`SET`å‘½ä»¤æ­£å¸¸æ‰§è¡Œé‚£ä¹ˆå›è¿”å›`OK` [å¤šè¡Œå­—ç¬¦ä¸²](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Ftopics%2Fprotocol.html%23bulk-string-reply): ä½¿ç”¨ GET é€‰é¡¹ï¼Œè¿”å› key å­˜å‚¨çš„å€¼ï¼Œå¦‚æœ key ä¸å­˜åœ¨è¿”å›ç©º: å¦åˆ™å¦‚æœåŠ äº†`NX` æˆ–è€… `XX`é€‰é¡¹ï¼Œ[SET](https://link.juejin.cn?target=https%3A%2F%2Fredis.com.cn%2Fcommands%2Fset.html) æ²¡æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šè¿”å›nilã€‚

**ä¾‹å­**ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/1aaf725ade824172be214bf9d33c5d82tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

ä»è¿™ä¸ªå°æ¡ˆä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ç¬¦åˆæˆ‘ä»¬è¦çš„å‘½ä»¤çš„~

Java ä»£ç å®ç°ï¼šè¿™ä¸€æ­¥çš„ä»£ç å®ç°å’Œä¸Šä¸€å°èŠ‚ç›¸æ¯”ï¼Œä»…æ”¹åŠ¨äº†ä¸€è¡Œä»£ç ï¼š

ä¸Šä¸€å°èŠ‚ï¼š

```java
Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, SET_NX_EX_MENU_LIST_LOCK_VALUE);
å¤åˆ¶ä»£ç 
```

åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼š

```java
Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, SET_NX_EX_MENU_LIST_LOCK_VALUE, 5L, TimeUnit.SECONDS);
å¤åˆ¶ä»£ç 
```

å°±è¿™æ ·ï¼Œå†é‚£æ ·ï¼Œå†è¿™æ ·ï¼Œä½ çœ‹æ­»é”é—®é¢˜å°±è¢«è§£å†³å•¦ğŸ˜œ

**æ­»é”é—®é¢˜ç¡®å®è¢«è§£å†³äº†ï¼Œç°åœ¨ä½ è§‰å¾—è¿˜æœ‰é—®é¢˜å—**ï¼Ÿ

æˆ‘ä»¬æŠŠå®ƒçš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æ‹†åˆ†æ¥çœ‹ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢çš„è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š

å‡è®¾æˆ‘ä»¬çº¦å®šé”è¿‡æœŸæ—¶é—´ä¸º`5s`ï¼Œä½†æ˜¯æ‰§è¡Œè¿™ä¸ªä¸šåŠ¡æ—¶çªç„¶å¡èµ·æ¥ï¼Œæ­¤ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†æˆ‘ä»¬é¢„ä¼°çš„ `5s`ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š

ç¬¬ä¸€æ¡çº¿ç¨‹æŠ¢åˆ°é”ï¼Œä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œç¬¬ä¸€æ¡çº¿ç¨‹æ‰€æŒæœ‰çš„é”è¢«**è‡ªåŠ¨é‡Šæ”¾**ï¼›æ­¤æ—¶ç¬¬äºŒæ¡çº¿ç¨‹æ‹¿åˆ°é”ï¼Œå‡†å¤‡æ‰§è¡Œä¸šåŠ¡ï¼Œåˆšå¥½ç¬¬ä¸€æ¡çº¿ç¨‹ä¸šåŠ¡æ‰§è¡Œå®Œæˆï¼Œç…§å¸¸æ‰§è¡Œäº†é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œ**å¯¼è‡´ç¬¬äºŒæ¡çº¿ç¨‹æŒæœ‰çš„é”è¢«ç¬¬ä¸€æ¡çº¿ç¨‹æ‰€é‡Šæ”¾ï¼Œé”è¢«å…¶ä»–äººé‡Šæ”¾**ã€‚

è¿™ä¸ªæƒ…å†µä¸­å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1. ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œé”è¢«è‡ªåŠ¨é‡Šæ”¾
2. é”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œå¯¼è‡´ä¸šåŠ¡å‡ºç°é—®é¢˜

å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¸¸è¯´çš„**é”ç»­æœŸé—®é¢˜**ï¼Œè¿™ç‚¹ä¹‹ååœ¨ä½¿ç”¨ Redission æ—¶å†ç»†è°ˆã€‚

ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå°±æ¯”è¾ƒå¥½è§£å†³äº†ï¼Œæˆ‘ä»¬æ¯æ¬¡åŠ é”çš„æ—¶å€™ï¼Œå¸¦ä¸Šè‡ªå·±çš„èº«ä»½æ ‡è¯†ï¼Œåœ¨è§£é”çš„æ—¶å€™ï¼Œè¿›è¡Œä¸€æ¬¡åˆ¤æ–­å³å¯ã€‚

æ¥ç€å¾€ä¸‹çœ‹å§ ğŸ‘‡

### 3.3ã€é”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

æˆ‘ä»¬æ¯æ¬¡åŠ é”çš„æ—¶å€™ï¼Œå¸¦ä¸Šè‡ªå·±çš„èº«ä»½æ ‡è¯†ï¼Œåœ¨è§£é”çš„æ—¶å€™ï¼Œè¿›è¡Œä¸€æ¬¡åˆ¤æ–­å³å¯ã€‚

æ¯”å¦‚ï¼šåŠ é”çš„æ—¶å€™ï¼Œç”Ÿæˆä¸€ä¸ª`UUID`ä½œä¸º `KEY`ï¼Œé‡Šæ”¾é”æ—¶ï¼Œè·å–ä¸€ä¸‹é”ï¼Œåˆ¤æ–­ä¸€ä¸‹`UUID`æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™æ‰§è¡Œåˆ é™¤ï¼Œå¦åˆ™ä¸æ‰§è¡Œåˆ é™¤ã€‚

åœ¨ Redis ä¸­å‘½ä»¤æ¼”ç¤ºå¦‚ä¸‹ï¼š

è®¾ç½®é”ï¼š`set uuid  "lock" NX EX 60`

é‡Šæ”¾é”ï¼š1ã€`get uuid`ï¼Œèº«ä»½æ ‡è¯†ç›¸ç­‰ï¼Œåˆ™æ‰§è¡Œ2ï¼›2ã€` del uuid`

![image.png](/assets/blog_res/2023-02-04-Block.assets/f523754707e44c03ad56e56f993e4f25tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

Java ä»£ç å¦‚ä¸‹ï¼š

```java
@Service
public class SetNxExLockServiceImpl implements ISetNxExLockService {

    @Autowired
    StringRedisTemplate stringRedisTemplate;

    @Autowired
    private MenuMapper menuMapper;

    private static final String SET_NX_EX_MENU_LIST = "set:nx:ex:menu:list";
    private static final String SET_NX_EX_MENU_LIST_LOCK = "set:nx:ex:menu:list:lock";
    private static final String SET_NX_EX_MENU_LIST_LOCK_VALUE = "lock";


    @Override
    public List<MenuEntity> getList() {
        // åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®
        String menuJson = stringRedisTemplate.opsForValue().get(SET_NX_EX_MENU_LIST);
        if (menuJson != null) {
            System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®");
            List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
            });
            return menuEntityList;
        }

        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
        List<MenuEntity> result = getMenuJsonFromDbWithRedisLock();

        return result;
    }


    /**
     * é—®é¢˜ï¼šé”è¢«å…¶ä»–äººé‡Šæ”¾ï¼Œè¿™è¯¥å¦‚ä½•å¤„ç†ã€‚
     * åŠ é”çš„æ—¶å€™ï¼Œå°†å€¼ç»™å®šä½ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ UUID ï¼‰
     * 1ã€è§£é”ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±è·å–çš„é‚£æŠŠé”ï¼Œ
     * 2ã€ç¡®å®šæ˜¯ä¸€æŠŠé”å°±æ‰§è¡Œ è§£é”é”æ“ä½œ
     *
     * @return
     */
    public List<MenuEntity> getMenuJsonFromDbWithRedisLock() {
        List<MenuEntity> result = new ArrayList<>();
        System.out.println("ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==>");
        // ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´
        String uuid = UUID.randomUUID().toString();
        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, uuid, 5L, TimeUnit.SECONDS);
        if (lock) {
            System.out.println("è·å–åˆ†å¸ƒå¼é”æˆåŠŸ...");
            try {
                //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
                result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
                stringRedisTemplate.opsForValue().set(SET_NX_EX_MENU_LIST, JSON.toJSONString(result));
            } finally {
                // è·å–é”ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹çš„é”
                String token = stringRedisTemplate.opsForValue().get(SET_NX_EX_MENU_LIST_LOCK);
                if (uuid.equals(token)) {
                    // ç¡®å®šæ˜¯åŒä¸€æŠŠé”ï¼Œ æ‰é‡Šæ”¾é”
                    stringRedisTemplate.delete(SET_NX_EX_MENU_LIST_LOCK);
                }
            }
            return result;
            /**
             * é‚£è¿™æ ·å°±æ²¡æœ‰é—®é¢˜äº†å—ï¼Ÿ
             * å¹¶ä¸æ˜¯ã€‚
             * è¿™é‡Œå­˜åœ¨çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåˆ é™¤æ“ä½œå·²ç»ä¸åœ¨æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œäº†ã€‚
             * 1ã€ä¸€ä¸ªæ˜¯æŸ¥è¯¢åˆ¤æ–­
             * 2ã€ç¬¬äºŒä¸ªæ‰æ˜¯è§£é”æ“ä½œ
             * é‚£ä¹ˆåˆä¼šæ‹†åˆ†æˆï¼Œå¦‚æœæˆ‘ç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸï¼Œç¬¬äºŒæ­¥æ‰§è¡Œå¤±è´¥çš„åœºæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠå®ƒå˜æˆåŸå­æ“ä½œæ‰è¡Œã€‚
             */
        } else {
            System.out.println("è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•...");
            //åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶
            //ä¼‘çœ ä¸€ç™¾æ¯«ç§’
            try {
                TimeUnit.MILLISECONDS.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            return getMenuJsonFromDbWithRedisLock();
        }

    }
    @Override
    public Boolean updateMenuById(MenuEntity menu) {
        //        return updateMenuByIdWithLock(menu);
        //        return updateMenuWithExpireLock(menu);
        return updateMenuWithRedisLock(menu);
    }

  
    public Boolean updateMenuWithExpireLock(MenuEntity menu) {
        // ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´
        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, SET_NX_EX_MENU_LIST_LOCK_VALUE, 5L, TimeUnit.SECONDS);
        Boolean update = false;
        if (lock) {
            System.out.println("æ›´æ–°æ“ä½œï¼šè·å–åˆ†å¸ƒå¼é”æˆåŠŸ===> æ¸…é™¤ç¼“å­˜");
            try {
                // åˆ é™¤ç¼“å­˜
                stringRedisTemplate.delete(SET_NX_EX_MENU_LIST);
                // æ›´æ–°æ•°æ®åº“
                update = menuMapper.updateById(menu) > 0;
            } finally {
                // ä¸€å®šè¦é‡Šæ”¾é”ï¼Œä»¥å…é€ æˆæ­»é”é—®é¢˜
                stringRedisTemplate.delete(SET_NX_EX_MENU_LIST_LOCK);
            }
            return update;
        }  else{
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            return updateMenuWithExpireLock(menu);
        }
    }

}
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆè¿™å°±æ²¡æœ‰é—®é¢˜äº†å—ï¼Ÿ

å¹¶ä¸æ˜¯ã€‚è¿™é‡Œå­˜åœ¨çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåˆ é™¤æ“ä½œåˆå·²ç»ä¸å†æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œäº†ã€‚

- ç¬¬ä¸€æ­¥æ˜¯æŸ¥è¯¢åˆ¤æ–­
- ç¬¬äºŒæ­¥æ‰æ˜¯è§£é”æ“ä½œ

é‚£ä¹ˆç»§è€Œåˆä¼šå‡ºç°ï¼Œæˆ‘ç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸï¼Œç¬¬äºŒæ­¥æ‰§è¡Œå¤±è´¥çš„åœºæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æŠŠå®ƒå˜æˆåŸå­æ€§æ“ä½œæ‰è¡Œã€‚

è¿™ä¸ªæ—¶å°±è¦ç”¨åˆ°äº† Redis ä¸­çš„ lua è„šæœ¬å•¦~

è®©å®ƒå»å¸®åŠ©æˆ‘ä»¬å®ç°å°†åˆ¤æ–­å’Œè§£é”å˜æˆä¸€æ­¥åŸå­æ€§æ“ä½œ~ æ¥ç€çœ‹å§

### 3.4ã€lua è„šæœ¬å®ç°åˆ†å¸ƒå¼é”

å…¶å®æœ‰é˜…è¯»è¿‡ Redis å®˜æ–¹æ–‡æ¡£çš„æœ‹å‹ï¼Œåœ¨çœ‹ä¸Šé¢çš„é‚£ä¸ª `set`å‘½ä»¤çš„æ–‡æ¡£æ—¶ï¼Œå°±ä¼šå‘ç°ï¼Œå…¶å®æ»‘åˆ°ä¸‹åŠéƒ¨åˆ†ï¼ŒRedis å°±æœ‰æåˆ°ä¸æ¨èä½¿ç”¨`SET resource-name anystring NX EX max-lock-time` è¿™ä¸ªç®€å•æ–¹æ³•æ¥å®ç°åˆ†å¸ƒå¼é”~

å¹¶ä¸”ä¹Ÿç»™å‡ºäº†ç›¸åº”çš„å»ºè®®ï¼šå¦‚ä¸‹å›¾

![image.png](/assets/blog_res/2023-02-04-Block.assets/672f255cac16449496e395329feafe53tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

```vbnet
if redis.call("get",KEYS[1]) == ARGV[1]
then
    return redis.call("del",KEYS[1])
else
    return 0
end
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬ä½¿ç”¨çš„å…¶å®å°±æ˜¯ä¸Šé¢çš„è„šæœ¬ï¼Œå“ˆå“ˆ

```java
@Service
public class SetNxExLockServiceImpl implements ISetNxExLockService {

    @Autowired
    StringRedisTemplate stringRedisTemplate;

    @Autowired
    private MenuMapper menuMapper;

    private static final String SET_NX_EX_MENU_LIST = "set:nx:ex:menu:list";
    private static final String SET_NX_EX_MENU_LIST_LOCK = "set:nx:ex:menu:list:lock";
    private static final String SET_NX_EX_MENU_LIST_LOCK_VALUE = "lock";


    @Override
    public List<MenuEntity> getList() {
        // åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®
        String menuJson = stringRedisTemplate.opsForValue().get(SET_NX_EX_MENU_LIST);
        if (menuJson != null) {
            System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®");
            List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
            });
            return menuEntityList;
        }

        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
        List<MenuEntity> result = getMenuJsonFormDbWithLock();

        return result;
    }

    /**
     * é—®é¢˜ï¼šé‡Šæ”¾é”æ“ä½œ ä¸¢å¤± åŸå­æ€§
     * è§£å†³æ–¹æ¡ˆ: lua è„šæœ¬
     * æ—¢ç„¶åˆ é™¤æ“ä½œå˜æˆäº†ä¸¤æ­¥ï¼Œå¤±å»äº†åŸå­æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒæ”¹æˆä¸€æ­¥å°±è¡Œå•¦å‘€ï¼Œ
     * æ­¤æ—¶å°±å¾—ç”¨ä¸Šæˆ‘ä»¬çš„ lua è„šæœ¬äº†
     *
     * @return
     */
    public List<MenuEntity> getMenuJsonFormDbWithLuaLock() {
        List<MenuEntity> result = new ArrayList<>();
        System.out.println("ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ é”ï¼Œé‡æ–°ä»æ•°æ®ä¸­æŸ¥è¯¢~==>");
        // ç»™é”è®¾å®šä¸€ä¸ªæ—¶é—´
        String uuid = UUID.randomUUID().toString();
        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, uuid, 5L, TimeUnit.SECONDS);
        if (lock) {
            System.out.println("è·å–åˆ†å¸ƒå¼é”æˆåŠŸ...");
            try {
                //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
                result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
                stringRedisTemplate.opsForValue().set(SET_NX_EX_MENU_LIST, JSON.toJSONString(result));
            } finally {
                // ç¼–å†™ lua è„šæœ¬
                String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end";
                //åˆ é™¤é”  execute è¿™ä¸ªæ”¾ç•ªä¸­çš„å‚æ•°å¯èƒ½è¿˜éœ€è¦æä¸€æ
                stringRedisTemplate.execute(new DefaultRedisScript<Long>(script, Long.class), Arrays.asList(SET_NX_EX_MENU_LIST_LOCK), uuid);
            }
            return result;
        } else {
            System.out.println("è·å–åˆ†å¸ƒå¼é”å¤±è´¥...ç­‰å¾…é‡è¯•...");
            //åŠ é”å¤±è´¥...é‡è¯•æœºåˆ¶
            //ä¼‘çœ ä¸€ç™¾æ¯«ç§’
            try {
                TimeUnit.MILLISECONDS.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            return getMenuJsonFormDbWithLuaLock();
        }
    }

    @Override
    public Boolean updateMenuById(MenuEntity menu) {
//        return updateMenuByIdWithLock(menu);
//        return updateMenuWithExpireLock(menu);
        return updateMenuWithLuaLock(menu);
    }
    /**
     * é—®é¢˜ï¼šé‡Šæ”¾é”æ“ä½œ ä¸¢å¤± åŸå­æ€§
     * è§£å†³æ–¹æ¡ˆ: lua è„šæœ¬
     * æ—¢ç„¶åˆ é™¤æ“ä½œå˜æˆäº†ä¸¤æ­¥ï¼Œå¤±å»äº†åŸå­æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒæ”¹æˆä¸€æ­¥å°±è¡Œå•¦å‘€ï¼Œ
     * æ­¤æ—¶å°±å¾—ç”¨ä¸Šæˆ‘ä»¬çš„ lua è„šæœ¬äº†
     *
     * @return
     */
    public Boolean updateMenuWithRedisLock(MenuEntity menu) {
        String uuid = UUID.randomUUID().toString();
        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(SET_NX_EX_MENU_LIST_LOCK, uuid, 5L, TimeUnit.SECONDS);
        Boolean update = false;
        if (lock) {
            System.out.println("è·å–åˆ†å¸ƒå¼é”æˆåŠŸ...");
            try {
                //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
                stringRedisTemplate.delete(SET_NX_EX_MENU_LIST);
                // æ›´æ–°æ•°æ®åº“
                update = menuMapper.updateById(menu) > 0;
            } finally {
                // è·å–é”ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹çš„é”
                String token = stringRedisTemplate.opsForValue().get(SET_NX_EX_MENU_LIST_LOCK);
                if (uuid.equals(token)) {
                    // ç¡®å®šæ˜¯åŒä¸€æŠŠé”ï¼Œ æ‰é‡Šæ”¾é”
                    stringRedisTemplate.delete(SET_NX_EX_MENU_LIST_LOCK);
                }
            }
            return update;
        } else{
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            return updateMenuWithRedisLock(menu);
        }
    }
}
å¤åˆ¶ä»£ç 
```

å€ŸåŠ© lua è„šæœ¬æˆ‘ä»¬æˆåŠŸå°†é‡Šæ”¾é”çš„æ“ä½œå˜æˆåŸå­æ€§æ“ä½œï¼Œç¡®ä¿äº†å…¶æ­£ç¡®æ€§ã€‚

å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºåˆ†å¸ƒå¼é”çš„æ¥é¾™å»è„‰ï¼Œåº”è¯¥äº§ç”Ÿäº†ä¸€äº›å±äºè‡ªå·±çš„ç†è§£ï¼Œç°åœ¨å°±åªå‰©ä¸‹ä¸€ä¸ªé”è‡ªåŠ¨ç»­æœŸçš„é—®é¢˜æ²¡æœ‰è§£å†³äº†~

### 3.5ã€Redisson å®ç°åˆ†å¸ƒå¼é”

**é”éœ€è¦ç»­æœŸï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†è§£å†³åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸šåŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œé”å·²ç»è¿‡æœŸï¼Œä½†ä¸šåŠ¡ä»æ²¡æ‰§è¡Œå®Œæˆçš„åœºæ™¯**ã€‚

ç©¶å…¶æ ¹æœ¬å°±æ˜¯åˆ°åº•ç»™é”å¤šé•¿æ—¶é—´ç®—åˆé€‚å‘¢ï¼Ÿè¿™ç‚¹å…¶å®æ˜¯æ²¡æ³•å‡†ç¡®è¯„ä¼°çš„ã€‚

> å¦‚æœä¸æ‰“ç®—ç»™é”è‡ªåŠ¨ç»­æœŸçš„è¯ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—åº”å½“å¯¹é”çš„è¿‡æœŸæ—¶é—´ï¼Œé€‚å½“çš„å»¶é•¿ä¸€äº›ï¼Œä»¥ç¡®ä¿ä¸šåŠ¡æ­£ç¡®æ‰§è¡Œã€‚

å¦‚æœä½ å’Œæˆ‘ä¸€æ ·æ˜¯ä¸€åJavaå¼€å‘è€…ï¼Œæƒ³è¦å»å®ç°é”è‡ªåŠ¨ç»­æœŸï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨å¸‚é¢ä¸Šå·²ç»æœ‰æˆç†Ÿçš„è½®å­[Redisson](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson) å•¦~

åœ¨Redissonä¸­ï¼Œæœ‰ä¸€ä¸ªè‘—åçš„**çœ‹é—¨ç‹—æœºåˆ¶**ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ `Redisson` æ¥å®ç°åˆ†å¸ƒå¼é”æ—¶ï¼ŒåŠ é”æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šé»˜è®¤è®¾ç½®è¿‡æœŸæ—¶é—´30sï¼Œç„¶åå½“ä¸šåŠ¡æ‰§è¡Œè¶…è¿‡10sï¼Œä¹Ÿå°±æ˜¯é”æ—¶é—´è¿˜å‰©ä¸‹ 20s æ—¶ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨ç»­æœŸã€‚

**å…‰è¯´ä¸ç»ƒå‡æŠŠå¼**ï¼Œæˆ‘ä»¬ç›´æ¥æ¥ç”¨ä»£ç å®ç°ä¸€ä¸‹çœ‹çœ‹å§

å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.17.6</version>
</dependency>
å¤åˆ¶ä»£ç 
```

é¦–å…ˆå°±æ˜¯`SpringBoot`çš„èµ·æ‰‹å¼ï¼Œç¼–å†™`MyRedissionConfig` ç±»

```java
@Configuration
public class MyRedissonConfig {

    /**
     * æ‰€æœ‰å¯¹Redissonçš„ä½¿ç”¨éƒ½æ˜¯é€šè¿‡RedissonClient
     * @return
     * @throws IOException
     */
    @Bean(destroyMethod="shutdown")
    public RedissonClient redissonClient() throws IOException {
        //1ã€åˆ›å»ºé…ç½®
        Config config = new Config();
        // è¿æ¥å¿…é¡»è¦ä»¥ redis å¼€å¤´~ æœ‰å¯†ç å¡«å¯†ç 
        config.useSingleServer().setAddress("redis://IPåœ°å€:6379").setPassword("000415");
        //2ã€æ ¹æ®Configåˆ›å»ºå‡ºRedissonClientå®ä¾‹
        //Redis url should start with redis:// or rediss://
        RedissonClient redissonClient = Redisson.create(config);
        return redissonClient;
    }
}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸºäº`RedissonClient` æ¥å®ç°çš„ï¼Œå°†å®ƒæ³¨å…¥åˆ°Spring å®¹å™¨ä¸­ä¹‹åï¼Œåœ¨éœ€è¦çš„æ—¶å€™ç›´æ¥å¼•å…¥å³å¯ã€‚

å¦å¤– `Redisson` å®ƒå®ç°äº† JUC åŒ…ä¸‹çš„å¤§éƒ¨åˆ†é”ç›¸å…³çš„å®ç°ï¼Œå¦‚æœç†Ÿæ‚‰ JUC çš„å¼€å‘ï¼Œä½¿ç”¨è¿™æ–¹é¢ç®—æ˜¯æ²¡ä»€ä¹ˆå­¦ä¹ æˆæœ¬çš„ã€‚å¦‚JUC ä¸‹çš„è¯»å†™é”ã€ä¿¡å·é‡ç­‰ã€‚

æˆ‘ä»¬å°±æ¥ä½¿ç”¨ä¸€ä¸‹`Redisson`ä¸­çš„è¯»å†™é”å§~

```typescript
/**
 * @description:
 * @author: Ning Zaichun
 * @date: 2022å¹´09æœˆ20æ—¥ 20:59
 */
@Service
public class RedissonServiceImpl implements IRedissonService {

    @Autowired
    StringRedisTemplate stringRedisTemplate;

    @Autowired
    private MenuMapper menuMapper;

    private static final String REDISSON_MENU_LIST = "redisson:menu:list";
    private static final String REDISSON_MENU_LIST_LOCK_VALUE = "redisson:lock";
    @Autowired
    private RedissonClient redissonClient;


    @Override
    public List<MenuEntity> getList() {
        // åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®
        String menuJson = stringRedisTemplate.opsForValue().get(REDISSON_MENU_LIST);
        if (menuJson != null) {


            System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®");
            List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
            });
            return menuEntityList;
        }

        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢
        List<MenuEntity> result = getMenuJsonFromDbWithRedissonLock();

        return result;
    }



    /**
     * é—®é¢˜ï¼šå…¶å®å†™æˆä¸Šé¢é‚£ç§æ¨¡æ ·ï¼Œç›¸å¯¹æ¥è¯´ï¼Œä¹Ÿèƒ½è§£å†³å¾ˆå¤šæ—¶å€™çš„é—®é¢˜äº†ï¼Œä»å¤´åˆ°å°¾çœ‹è¿‡æ¥çš„è¯ï¼Œå…¶å®ä¹Ÿèƒ½å‘ç°å°±ä¸€ä¸ªé”è‡ªåŠ¨è¿‡æœŸé—®é¢˜æ²¡æœ‰è§£å†³äº†ã€‚
     * ä½†åœ¨å®ç°è¿™ä¸ªä¹‹å‰ï¼Œæˆ‘è¿˜æ˜¯è¯´æ˜ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¯´åœ¨æ²¡æœ‰è§£å†³é”è‡ªåŠ¨è¿‡æœŸé—®é¢˜æ—¶ï¼Œå°±å·²ç»èƒ½åº”ä»˜å¤§å¤šæ•°åœºæ™¯äº†ã€‚
     * é‡ç‚¹åœ¨äºå¦‚ä½•è¯„ä¼° é”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´åˆ°åº•è®¾ç½®å¤šå°‘åˆé€‚å‘¢ï¼Ÿ
     * å…¶å®å¦‚æœå¯¹äºä¸šåŠ¡ç†è§£è¾ƒä¸ºé€å½»ï¼Œå¯¹äºè¿™ä¸€éƒ¨åˆ†çš„ä¸šåŠ¡ä»£ç æ‰§è¡Œæ—¶é—´èƒ½æœ‰ä¸€ä¸ªè¾ƒæ¸…æ™°çš„ä¼°ç®—ï¼Œç»™å®šä¸€ä¸ªåˆé€‚çš„æ—¶é—´ï¼Œåœ¨ä¸å‡ºç°æç«¯æƒ…å†µï¼ŒåŸºæœ¬éƒ½èƒ½åº”ä»˜è¿‡æ¥äº†ã€‚
     * <p>
     * ä½†æ˜¯å‘¢ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæ€•è¿™ä¸ªä¸‡ä¸€çš„ï¼Œä¸‡ä¸€çœŸå‡ºç°äº†ï¼Œå¯èƒ½é€ æˆçš„æŸå¤±å°±ä¸æ­¢ ä¸€ä¸‡äº†ï¼Œå“ˆå“ˆã€‚
     * è§£å†³æ–¹æ¡ˆ
     * 1ã€åœ¨å¸‚åœºä¸»æµçš„ Redission ä¸­ï¼Œé’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚è¿™ä¹Ÿæ˜¯Redissionä¸­å¸¸è¯´çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚
     * <p>
     * å¦‚æœéœ€è¦è‡ªå·±å®ç°çš„æ€è·¯ï¼š
     * 1ã€è¿™æ–¹é¢çš„é—®é¢˜ï¼Œä¹Ÿåšäº†ååˆ†æµ…æ˜¾çš„æ€è€ƒï¼Œæˆ‘è§‰å¾—åº”è¯¥è¿˜æ˜¯ä¾èµ–äºå®šæ—¶ä»»åŠ¡å»å®ç°ï¼Œä½†åˆ°åº•è¯¥å¦‚ä½•å®ç°è¿™ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæˆ‘è¿˜æ²¡æ³•ç»™å‡ºä¸€ä¸ªåˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚ æˆ–è®¸æˆ‘åº”è¯¥ä¼šå°è¯•ä¸€ä¸‹ã€‚
     *
     * @return
     */
    public List<MenuEntity> getMenuJsonFromDbWithRedissonLock() {
        System.out.println("ä»æ•°æ®åº“ä¸­æŸ¥è¯¢");
        //1ã€å åˆ†å¸ƒå¼é”ã€‚å»rediså å‘
        //ï¼ˆé”çš„ç²’åº¦ï¼Œè¶Šç»†è¶Šå¿«:å…·ä½“ç¼“å­˜çš„æ˜¯æŸä¸ªæ•°æ®ï¼Œ11å·å•†å“ï¼‰ product-11-lock
        //RLock catalogJsonLock = redissonClient.getLock("catalogJson-lock");
        //åˆ›å»ºè¯»é”
        RReadWriteLock readWriteLock = redissonClient.getReadWriteLock(REDISSON_MENU_LIST_LOCK_VALUE);
        RLock rLock = readWriteLock.readLock();
        List<MenuEntity> result = null;
        try {
            rLock.lock();
            String menuJson = stringRedisTemplate.opsForValue().get(REDISSON_MENU_LIST);
            if (menuJson != null) {
                System.out.println("ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®");
                List<MenuEntity> menuEntityList = JSON.parseObject(menuJson, new TypeReference<List<MenuEntity>>() {
                });
                return menuEntityList;
            }
            try {
                Thread.sleep(50000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
            //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
            result = menuMapper.selectList(new QueryWrapper<MenuEntity>());
            // æ„å»ºç¼“å­˜
            stringRedisTemplate.opsForValue().set(REDISSON_MENU_LIST, JSON.toJSONString(result));
        } finally {
            rLock.unlock();
        }
        return result;
    }


    @Override
    public Boolean updateMenuById(MenuEntity menu) {
        return updateMenuWithRedissonLock(menu);
    }

    public Boolean updateMenuWithRedissonLock(MenuEntity menu) {
        RReadWriteLock readWriteLock = redissonClient.getReadWriteLock(REDISSON_MENU_LIST_LOCK_VALUE);
        RLock writeLock = readWriteLock.writeLock();
        Boolean update = false;
        try {
            writeLock.lock();
            //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
            //åŠ é”æˆåŠŸ...æ‰§è¡Œä¸šåŠ¡
            update = menuMapper.updateById(menu) > 0;
        } finally {
            writeLock.unlock();
        }
        return update;
    }


}
å¤åˆ¶ä»£ç 
```

ä¸ºäº†ç»™å¤§å®¶æµ‹è¯•ä¸€ä¸‹å®ƒçš„è‡ªåŠ¨ç»­æœŸï¼Œæˆ‘åœ¨å®ƒç¬¬ä¸€æ¬¡æŸ¥è¯¢æ•°æ®åº“è·å–é”æ—¶ï¼Œè®©çº¿ç¨‹ç¡äº†ä¸€ä¼šï¼Œæ¥è¿›è¡Œæµ‹è¯•ã€‚

æµ‹è¯•ï¼š

![QQå½•å±20221020230329.gif](/assets/blog_res/2023-02-04-Block.assets/ce7352aa19b241098149ff3e5d45bb6atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

Redissionçš„ä¸€äº›å…¶ä»–ç”¨æ³•ä»¥åŠå†…éƒ¨æ˜¯å¦‚ä½•å®ç°é”ç»­æœŸçš„ç­‰ç­‰ï¼Œè¿™äº›éƒ½ç•™åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å•¦ã€‚

### 3.6ã€å…³äºRedissionçš„ä¸€äº›è¡¥å……

Redisson é»˜è®¤é”è¿‡æœŸæ—¶é—´ 30sï¼Œä¸€æ—¦è¿›è¡Œä¿®æ”¹äº†çš„è¯ï¼ŒRedissonä¼šå–æ¶ˆæ­¤é”çš„è‡ªåŠ¨ç»­æœŸæœºåˆ¶ã€‚ è¿™ä¸€æ­¥çš„æºç åœ¨ `RedissonLock`çš„`tryAcquireAsync`ä¸­ ![image.png](/assets/blog_res/2023-02-04-Block.assets/68d3f84e307f4e278d0235cc5fde6594tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

å¦å¤– `Redisson` è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼Œä¹Ÿè¢«å¤§å®¶ç§°ä¸ºçœ‹é—¨ç‹—æœºåˆ¶ï¼Œæ¯æ¬¡åœ¨é”è¿˜å‰©ä¸‹20ç§’çš„æ—¶å€™ï¼Œåˆä¼šè‡ªåŠ¨ç»­åˆ°30sã€‚ é»˜è®¤æ—¶é—´åœ¨ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/77a998d475014e929cdea906bd8b0675tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

![image.png](/assets/blog_res/2023-02-04-Block.assets/f74fd471ff9c4bc3a924e5998132964etplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

å…³äºRedissonåº•å±‚çš„ä¸€äº›æµç¨‹åˆ†æï¼Œåœ¨æ˜å¤©çš„å…³äº Redisson æºç æµ…æçš„æ–‡ç« å½“ä¸­ã€‚

### 3.7ã€æ­£ç¡®ä½¿ç”¨Redisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”

å…¶å®å°±ä¸‹é¢ä¸¤ç‚¹ï¼š

1. ä¸Šé”å’Œè®¾ç½®è¿‡æœŸæ—¶é—´éœ€è¦ä¿è¯åŸå­æ€§ï¼›ï¼ˆåŠ é”ï¼‰
2. åˆ¤æ–­é”IDæ˜¯å¦ä¸ºè‡ªå·±æ‰€æœ‰å’Œè§£é”éœ€è¦ä¿è¯åŸå­æ€§ ï¼ˆè§£é”ï¼‰

ä¿è¯è¿™ä¸¤æ­¥æ‰èƒ½ä¿è¯æ­£ç¡®ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå¦å¤–åˆ™æ˜¯å¯¹äºé”çš„è¿‡æœŸæ—¶é—´éœ€è¦è¿›è¡Œä¸€ä¸ªåˆç†è¯„ä¼°ï¼Œé€‚å½“å»¶é•¿é”è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœéœ€è¦å®ç°é”è‡ªåŠ¨ç»­æœŸå¯é‡‡ç”¨ç°æœ‰çš„è½®å­ Redisson æ¥å®ç°ã€‚

## å››ã€å°ç»“

### 4.1ã€å›é¡¾

æˆ‘ä»¬ä»æœ¬åœ°é”ä¸€ç›´è®²åˆ°åˆ†å¸ƒå¼é”ï¼Œå°†Rediså®ç°åˆ†å¸ƒå¼é”ä¸­çš„ä¸€äº›é—®é¢˜ï¼Œé€æ­¥è¿›è¡Œäº†è®²è¿°ã€‚

1. ä»ä½¿ç”¨ç®€å•çš„ `Redis `ä¸­çš„ `SET KEY NX`å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”
2. åˆ°ä½¿ç”¨`SET KEY NX EX TIME ` å‘½ä»¤è§£å†³æ­»é”é—®é¢˜
3. åˆ°å¢åŠ èº«ä»½æ ‡è¯†ï¼ˆUUIDï¼‰ è§£å†³é”è¢«å…¶ä»–äººé‡Šæ”¾é—®é¢˜
4. å†åˆ°ä½¿ç”¨ Lua è„šæœ¬ï¼Œå°†è§£é”æ“ä½œå˜æˆåŸå­æ€§æ“ä½œ
5. æœ€åè®²è¿°äº†`Redisson`å®ç°åˆ†å¸ƒå¼é”ï¼Œè§£å†³äº†é”è‡ªåŠ¨ç»­æœŸé—®é¢˜

è¯´å®ƒéå¸¸éš¾çš„è¯ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰ï¼Œä½†æ˜¯è¿™æ˜¯ç»ˆç‚¹å—ï¼Ÿ

### 4.2ã€æ‰©å±•

å…¶å®å¹¶ä¸æ˜¯ï¼Œä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰å‘ç°æˆ‘ä¸Šé¢æ‰€è®²è¿°çš„åˆ†å¸ƒå¼é”ï¼Œä»å§‹è‡³ç»ˆéƒ½æ˜¯å°†`Redis`å½“ä½œäº†ä¸€ä¸ªå®ä¾‹æ¥çœ‹å¾…ã€‚

ä½†åœ¨çœŸæ­£çš„ç¯å¢ƒä¸­ï¼Œ`Redis `è¿œä¸æ­¢ä¸€ä¸ªå®ä¾‹ï¼Œéƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å¤šæ ·çš„ï¼Œä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼ï¼Œä¸»ä»é›†ç¾¤ç­‰ç­‰ï¼Œé‚£ä¹ˆåœ¨è¿™äº›æƒ…å†µä¸‹ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼å»ç¼–å†™åˆ†å¸ƒå¼é”ä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿ

> ä½ è§‰å¾—å‘¢ï¼Ÿ

**ç­”æ¡ˆæ˜¯åªè¦ç‰µæ‰¯åˆ°ç½‘ç»œé€šä¿¡ï¼Œé‚£ä¹ˆå¿…ç„¶å°±ä¼šäº§ç”Ÿé—®é¢˜**ã€‚ ï¼ˆå¯ä»¥è¯´åœ¨åˆ†å¸ƒå¼ä¸­ï¼Œç½‘ç»œæ°¸è¿œéƒ½æ˜¯å¤„äºä¸ªä¸å¯ä¿¡çš„çŠ¶æ€ï¼‰

ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š

å‡è®¾ç°åœ¨çš„éƒ¨ç½²æ–¹å¼æ˜¯`ä¸»ä»é›†ç¾¤+å“¨å…µæ¨¡å¼`ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå½“ä¸»åº“å¼‚å¸¸å®•æœºæ—¶ï¼Œå“¨å…µå¯ä»¥å®ç°ã€Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢ã€ï¼ŒæŠŠä»åº“æå‡ä¸ºä¸»åº“ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼Œä»¥æ­¤ä¿è¯å¯ç”¨æ€§ã€‚

é‚£å‡è®¾ç°åœ¨æˆ‘ä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œåˆšè·å–åˆ°é”ï¼Œç„¶åä¸»èŠ‚ç‚¹å°±æŒ‚äº†ï¼Œæ­¤æ—¶é”è¿˜æ²¡æœ‰åŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸Šå»ï¼Œå³ä½¿ä¹‹åå®Œæˆäº†ä¸»ä»åˆ‡æ¢ï¼Œä½†æ˜¯æ­¤æ¬¡æ‰€åŠ çš„é”ä¹Ÿå·²ç»ä¸¢å¤±ã€‚

å› æ­¤åœ¨è¿™æ ·çš„åŸºç¡€ä¸Šï¼ŒRedis å®˜æ–¹ç»§è€Œåˆæ¨å‡ºäº† Redlock(çº¢é”ç®—æ³•)ã€‚

## äº”ã€å…³äºçº¢é” Redlock

å…³äºè¿™äº›é—®é¢˜ï¼ŒRedis çš„ä½œè€…ä¹Ÿæä¾›äº†ä¸€äº›è§£å†³æ–¹æ¡ˆã€Redlockã€‘ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çº¢é”ã€‚

å®˜æ–¹æ–‡æ¡£ï¼š[Redlock](https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdocs%2Freference%2Fpatterns%2Fdistributed-locks%2F)

çº¢é”åˆ†æ

------

1. Martin Kleppmannï¼ˆè‹±å›½å‰‘æ¡¥å¤§å­¦çš„ä¸€ååˆ†å¸ƒå¼ç³»ç»Ÿç ”ç©¶å‘˜ï¼‰[å…³äº Redlockçš„åˆ†æ](https://link.juejin.cn?target=http%3A%2F%2Fmartin.kleppmann.com%2F2016%2F02%2F08%2Fhow-to-do-distributed-locking.html)
2. Redis ä½œè€… Antirez å¯¹äº`Martin Kleppmann`çš„åˆ†æå›å¤

ä¸¤äººçš„è¾©è®ºéƒ½ååˆ†ç²¾å½©ï¼Œéå¸¸å€¼å¾—æ‹œè¯»ï¼Œä»ä¸­å¯ä»¥é¢†ç•¥åˆ°è¯¸å¤šå…³äºåˆ†å¸ƒå¼çš„æ€è€ƒã€‚

Redlock ç®€å•ä½¿ç”¨æ¥è‡ª Redis å®˜ç½‘

### 5.1ã€çº¢é”ç®—æ³•

åœ¨ç®—æ³•çš„åˆ†å¸ƒå¼ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ª Redis masterã€‚è¿™äº›èŠ‚ç‚¹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä½¿ç”¨å¤åˆ¶æˆ–ä»»ä½•å…¶ä»–éšå¼åè°ƒç³»ç»Ÿã€‚æˆ‘ä»¬å·²ç»æè¿°äº†å¦‚ä½•åœ¨å•ä¸ªå®ä¾‹ä¸­å®‰å…¨åœ°è·å–å’Œé‡Šæ”¾é”ã€‚æˆ‘ä»¬ç†æ‰€å½“ç„¶åœ°è®¤ä¸ºç®—æ³•ä¼šä½¿ç”¨è¿™ç§æ–¹æ³•åœ¨å•ä¸ªå®ä¾‹ä¸­è·å–å’Œé‡Šæ”¾é”ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº† N=5ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„è®¡ç®—æœºæˆ–è™šæ‹Ÿæœºä¸Šè¿è¡Œ 5 ä¸ª Redis ä¸»æœåŠ¡å™¨ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä»¥å‡ ä¹ç‹¬ç«‹çš„æ–¹å¼å‘ç”Ÿæ•…éšœã€‚

ä¸ºäº†**è·å–é”ï¼Œå®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹æ“ä½œ**ï¼š

1. å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è·å–å½“å‰æ—¶é—´ã€‚
2. å®ƒå°è¯•é¡ºåºè·å–æ‰€æœ‰ N ä¸ªå®ä¾‹ä¸­çš„é”ï¼Œåœ¨æ‰€æœ‰å®ä¾‹ä¸­ä½¿ç”¨ç›¸åŒçš„é”®åå’Œéšæœºå€¼ã€‚åœ¨æ­¥éª¤ 2 ä¸­ï¼Œå½“åœ¨æ¯ä¸ªå®ä¾‹ä¸­è®¾ç½®é”æ—¶ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ä¸€ä¸ªä¸é”è‡ªåŠ¨é‡Šæ”¾æ€»æ—¶é—´ç›¸æ¯”è¾ƒå°çš„è¶…æ—¶æ¥è·å–å®ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœè‡ªåŠ¨é‡Šæ”¾æ—¶é—´ä¸º 10 ç§’ï¼Œåˆ™è¶…æ—¶å¯èƒ½åœ¨ ~ 5-50 æ¯«ç§’èŒƒå›´å†…ã€‚è¿™å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯åœ¨å°è¯•ä¸å·²å…³é—­çš„ Redis èŠ‚ç‚¹é€šä¿¡æ—¶é•¿æ—¶é—´ä¿æŒé˜»å¡ï¼šå¦‚æœä¸€ä¸ªå®ä¾‹ä¸å¯ç”¨ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¿«å°è¯•ä¸ä¸‹ä¸€ä¸ªå®ä¾‹é€šä¿¡ã€‚
3. å®¢æˆ·ç«¯é€šè¿‡ä»å½“å‰æ—¶é—´ä¸­å‡å»æ­¥éª¤ 1 ä¸­è·å¾—çš„æ—¶é—´æˆ³æ¥è®¡ç®—è·å–é”æ‰€ç”¨çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“å®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨å¤§å¤šæ•°å®ä¾‹ï¼ˆè‡³å°‘ 3 ä¸ªï¼‰ä¸­è·å–é”æ—¶ï¼Œä¸”è·å–é”çš„æ€»æ—¶é—´å°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œåˆ™è®¤ä¸ºé”å·²è¢«è·å–ã€‚
4. å¦‚æœè·å¾—äº†é”ï¼Œåˆ™å…¶æœ‰æ•ˆæ—¶é—´è¢«è®¤ä¸ºæ˜¯åˆå§‹æœ‰æ•ˆæ—¶é—´å‡å»ç»è¿‡çš„æ—¶é—´ï¼Œå¦‚æ­¥éª¤ 3 ä¸­è®¡ç®—çš„é‚£æ ·ã€‚
5. å¦‚æœå®¢æˆ·ç«¯ç”±äºæŸç§åŸå› æœªèƒ½è·å¾—é”ï¼ˆå®ƒæ— æ³•é”å®š N/2+1 ä¸ªå®ä¾‹æˆ–æœ‰æ•ˆæ—¶é—´ä¸ºè´Ÿæ•°ï¼‰ï¼Œå®ƒå°†å°è¯•è§£é”æ‰€æœ‰å®ä¾‹ï¼ˆå³ä½¿æ˜¯å®ƒè®¤ä¸ºæ²¡æœ‰çš„å®ä¾‹ï¼‰èƒ½å¤Ÿé”å®šï¼‰ã€‚

### 5.2ã€ç®—æ³•æ˜¯å¼‚æ­¥çš„å—ï¼Ÿ

è¯¥ç®—æ³•ä¾èµ–äºè¿™æ ·ä¸€ä¸ªå‡è®¾ï¼Œå³è™½ç„¶è¿›ç¨‹ä¹‹é—´æ²¡æœ‰åŒæ­¥æ—¶é’Ÿï¼Œä½†æ¯ä¸ªè¿›ç¨‹ä¸­çš„æœ¬åœ°æ—¶é—´ä»¥å¤§è‡´ç›¸åŒçš„é€Ÿç‡æ›´æ–°ï¼Œä¸é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ç›¸æ¯”è¯¯å·®å¾ˆå°ã€‚è¿™ä¸ªå‡è®¾éå¸¸ç±»ä¼¼äºç°å®ä¸–ç•Œçš„è®¡ç®—æœºï¼šæ¯å°è®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªæœ¬åœ°æ—¶é’Ÿï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥ä¾é ä¸åŒçš„è®¡ç®—æœºæ¥è·å¾—å¾ˆå°çš„æ—¶é’Ÿæ¼‚ç§»ã€‚

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½åœ°æŒ‡å®šæˆ‘ä»¬çš„äº’æ–¥è§„åˆ™ï¼šåªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯åœ¨é”æœ‰æ•ˆæ—¶é—´å†…ï¼ˆå¦‚æ­¥éª¤ 3 ä¸­è·å¾—ï¼‰å†…ç»ˆæ­¢å…¶å·¥ä½œï¼Œå‡å»ä¸€äº›æ—¶é—´ï¼ˆä»…å‡ æ¯«ç§’ä¸ºäº†è¡¥å¿è¿›ç¨‹ä¹‹é—´çš„æ—¶é’Ÿæ¼‚ç§»ï¼‰ã€‚

æœ¬æ–‡åŒ…å«æœ‰å…³éœ€è¦ç»‘å®š*æ—¶é’Ÿæ¼‚ç§»*çš„ç±»ä¼¼ç³»ç»Ÿçš„æ›´å¤šä¿¡æ¯ï¼š[ç§Ÿèµï¼šåˆ†å¸ƒå¼æ–‡ä»¶ç¼“å­˜ä¸€è‡´æ€§çš„æœ‰æ•ˆå®¹é”™æœºåˆ¶](https://link.juejin.cn?target=http%3A%2F%2Fdl.acm.org%2Fcitation.cfm%3Fid%3D74870)ã€‚

### 5.3ã€å¤±è´¥é‡è¯•

å½“å®¢æˆ·ç«¯æ— æ³•è·å–é”æ—¶ï¼Œå®ƒåº”è¯¥åœ¨éšæœºå»¶è¿Ÿåé‡è¯•ï¼Œä»¥å°è¯•ä½¿å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å°è¯•è·å–åŒä¸€èµ„æºçš„é”ï¼ˆè¿™å¯èƒ½å¯¼è‡´æ²¡æœ‰äººçš„è„‘è£‚æƒ…å†µï¼‰èƒœï¼‰ã€‚æ­¤å¤–ï¼Œå®¢æˆ·ç«¯åœ¨å¤§å¤šæ•° Redis å®ä¾‹ä¸­å°è¯•è·å–é”çš„é€Ÿåº¦è¶Šå¿«ï¼Œè£‚è„‘æ¡ä»¶çš„çª—å£å°±è¶Šå°ï¼ˆå¹¶ä¸”éœ€è¦é‡è¯•ï¼‰ï¼Œå› æ­¤ç†æƒ³æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°è¯•å°†[`SET`](https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fcommands%2Fset)å‘½ä»¤å‘é€åˆ° N ä¸ªå®ä¾‹åŒæ—¶ä½¿ç”¨å¤šè·¯å¤ç”¨ã€‚

å€¼å¾—å¼ºè°ƒçš„æ˜¯ï¼Œå¯¹äºæœªèƒ½è·å¾—å¤§éƒ¨åˆ†é”çš„å®¢æˆ·ç«¯æ¥è¯´ï¼Œå°½å¿«é‡Šæ”¾ï¼ˆéƒ¨åˆ†ï¼‰è·å¾—çš„é”æ˜¯å¤šä¹ˆé‡è¦ï¼Œè¿™æ ·å°±æ— éœ€ç­‰å¾…å¯†é’¥åˆ°æœŸæ‰èƒ½å†æ¬¡è·å¾—é”ï¼ˆä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿç½‘ç»œåˆ†åŒºå¹¶ä¸”å®¢æˆ·ç«¯ä¸å†èƒ½å¤Ÿä¸ Redis å®ä¾‹é€šä¿¡ï¼Œåˆ™ä¼šåœ¨ç­‰å¾…å¯†é’¥åˆ°æœŸæ—¶é€ æˆå¯ç”¨æ€§æŸå¤±ï¼‰ã€‚

### 5.4ã€é‡Šæ”¾é”

é‡Šæ”¾é”å¾ˆç®€å•ï¼Œæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦ç›¸ä¿¡å®ƒèƒ½å¤ŸæˆåŠŸé”å®šç»™å®šå®ä¾‹ï¼Œéƒ½å¯ä»¥æ‰§è¡Œã€‚

å°±æ˜¯åŒæ—¶ç»™æ‰€æœ‰çš„ Redis å®ä¾‹å‘æ¶ˆæ¯è¯´è¦é‡Šæ”¾è¿™æŠŠé”ã€‚

æˆ‘æ­¤å¤„åªæ˜¯ä¸€ä¸ªç®€å•çš„æ€è·¯ï¼Œå¦‚æœå¯¹`Redlock`å±•å¼€è¯´ï¼Œè¿™ç¯‡æ–‡ç« çš„å­—æ•°å¯èƒ½è¿˜éœ€è¦ç¿»ä¸Šä¸€å€ï¼Œè€Œä¸”æˆ‘æ„Ÿè§‰å¦‚æœæ˜¯æ²¡æœ‰å®è·µçš„å»åˆ†æï¼Œæ–‡å­—ä¼šç¨æ˜¾ç¨šå«©ï¼ŒåŒæ—¶ä¹Ÿä¼šå› ä¸ºæ— æ¡ˆä¾‹æ”¯æ’‘ï¼Œè®©å…¶çœŸå®æ€§ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£ã€‚

æƒ³ä»”ç»†äº†è§£çš„ï¼Œå¤§å®¶å¯ä»¥å¤šæ‰¾æ‰¾ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šé’ˆå¯¹ä¸¤ä½å¤§ä½¬çš„è¾©è®ºåˆ†æçš„æ–‡ç« ã€‚

### 5.5ã€è¡¥å……

å…¶å®ï¼Œå¦‚æœä½ çš„åº”ç”¨åªéœ€è¦é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼é”å¹¶ä¸”å¯ä»¥æ¥å—ä¸€å®šç¨‹åº¦ä¸Šçš„æ•°æ®ä¸ä¸€è‡´æ€§ã€åƒä¹‹å‰è¯´çš„åˆšè®¾ç½®å®Œé”ï¼ŒRedisä¸­çš„ä¸»æœºå°±å®•æœºï¼Œå¯¼è‡´æ²¡æœ‰æˆåŠŸåŒæ­¥åˆ°ä»æœºï¼Œæ‰€äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´æ€§ã€‘ï¼Œé‚£ä¹ˆå®é™…ä¸Šä¹‹å‰æ‰€è®¨è®ºçš„ Redis åˆ†å¸ƒå¼é”ä¹Ÿæ˜¯è¶³å¤Ÿäº†çš„ã€‚

ä½†æ˜¯**å¦‚æœä¸šåŠ¡è¦æ±‚ä¸€å®šè¦ä¿è¯åº”ç”¨ä¸­æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—ä½ å¯ä»¥è¯•ç€æ‰¾æ‰¾å…¶ä»–çš„æ–¹å¼ï¼Œæ¢æˆ`zookeeper` åŠ ä¸Šä¸€å®šçš„è¡¥å¿æœºåˆ¶å»è¯•ä¸€è¯•**ã€‚æ¯•ç«ŸRedlock(çº¢é”)ä¸€æ–¹é¢å¤ªé‡äº†ï¼Œä¸æ˜¯ç‰¹åˆ«å¤§çš„é¡¹ç›®ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä¹Ÿä¸ä¼šç”¨è‡³å°‘äº”å°èµ·æ­¥çš„Rediså®ä¾‹å§ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œçœ‹äº†ä¸¤ä½å¤§ä½¬çš„è®¨è®ºï¼Œç‰¹åˆ«æç«¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½å‡ºç°é—®é¢˜çš„ã€‚

åˆšåˆšè¯´åˆ°çš„`Zookeeper` å®ç°åˆ†å¸ƒå¼é”,è™½ç„¶å®ƒä¹Ÿæœ‰é—®é¢˜ï¼Œä½†æ€»å½’å®ƒæ˜¯ä¿è¯`CAP`æœºåˆ¶ä¸­çš„`CP`çš„ï¼Œå¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»å¯¹`Zookeeper`çš„è®¿é—®è¯·æ±‚èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„æ•°æ®ï¼Œä½†ä¸ç»å¯¹ä¿è¯æœåŠ¡ä¸€å®šå¯ç”¨~ å±äºæ˜¯ç”¨æ€§èƒ½æ¢å®‰å…¨å•¦~

**æ€»ä¹‹ï¼Œå¦‚æœé¡¹ç›®ä¸­ä¸€å®šè¦æœ‰éå¸¸å¼ºçš„æ•°æ®ä¸€è‡´æ€§ï¼Œåœ¨é‚£ä¹ˆå¯¹äºåˆ†å¸ƒå¼é”ï¼Œä½ ä¹Ÿä¿ç•™ä¸€ä¸æ€€ç–‘ï¼Œæ¯•ç«Ÿå®ƒä¹Ÿä¸æ˜¯çœŸçš„100%å®‰å…¨çš„**ã€‚

æ—¢ç„¶çœ‹åˆ°è¿™é‡Œå•¦ï¼Œæˆ‘è§‰å¾—å†çœ‹ä¸€éå¤§çº²ï¼Œåˆ¤æ–­ä¸€ä¸‹è‡ªå·±ç†è§£äº†å¤šå°‘æ˜¯éå¸¸é‡è¦çš„ï¼š

![image.png](/assets/blog_res/2023-02-04-Block.assets/b7481691ca674351bc655359e7b41b8atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.image)

## å…³äºä»£ç 

ä¸çŸ¥é“é˜…è¯»çš„å°ä¼™ä¼´ï¼Œæœ‰æœ¨æœ‰å‘ç°ä»£ç ä¸­æœ‰ä¸€ç‚¹ç‚¹å°é—®é¢˜~

åæœŸåœ¨æ£€æŸ¥æ—¶ï¼Œæ¡ˆä¾‹ä¸­çš„ä»£ç æ˜¯æœ‰ç‚¹ä¸å¤ªåˆé€‚çš„ï¼Œ**åº”å½“å°†æ‰€æœ‰æ¡ˆä¾‹ä¸­çš„é€’å½’è°ƒç”¨æ–¹æ³•æ”¹ä¸ºå¾ªç¯é‡è¯•ï¼Œå¹¶é™åˆ¶é‡è¯•æ¬¡æ•°**ï¼Œè€Œéä¸€ç›´é€’å½’è°ƒç”¨ã€‚

> åŸå› ï¼šå¦‚æœä¸€ç›´æ²¡æœ‰æŠ¢åˆ°é”ï¼Œé‡å¤çš„é€’å½’è°ƒç”¨æ˜¯æœ‰å¾ˆå¤§å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒçš„,è¿™æ˜¯ä¸åˆé€‚çš„ã€‚**å¦å¤–å¦‚æœæ˜¯é˜…è¯»è¿‡ä¸€äº›æ¡†æ¶æºç çš„è¯ï¼Œå®ƒä»¬çš„åº•å±‚è°ƒç”¨å¤§éƒ½æ˜¯å†™ä¸ª`while(true)`æ¥è¾¾åˆ°æŸä¸ªæ–¹æ³•çš„é‡å¤è°ƒç”¨ï¼Œè€Œå¹¶éæ˜¯é€’å½’è°ƒç”¨**ã€‚
>
> æ­¤å¤„æ˜¯æˆ‘çš„ç–å¿½ï¼Œå„ä½è§è°…è§è°…ã€‚

å¦å¤–**é‡è¯•æœºåˆ¶ä¸‹å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜**ï¼š

**å¹‚ç­‰æ€§é—®é¢˜**ï¼š ï¼ˆæŸ¥è¯¢æ“ä½œå…·æœ‰å¤©ç„¶å¹‚ç­‰æ€§ï¼‰

åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨ä¼šå› ä¸ºç½‘ç»œåŸå› å‡ºç°è¶…æ—¶å¤±è´¥æƒ…å†µï¼Œè€Œé‡è¯•æœºåˆ¶ä¼šé‡å¤å¤šæ¬¡è°ƒç”¨æœåŠ¡ï¼Œä½†æ˜¯å¯¹äºè¢«è°ƒç”¨æ”¾ï¼Œå°±å¯èƒ½æ”¶åˆ°äº†å¤šæ¬¡è°ƒç”¨ã€‚å¦‚æœè¢«è°ƒç”¨æ–¹ä¸å…·æœ‰å¤©ç”Ÿçš„å¹‚ç­‰æ€§ï¼Œé‚£å°±éœ€è¦å¢åŠ æœåŠ¡è°ƒç”¨çš„åˆ¤é‡æ¨¡å—ï¼Œå¹¶å¯¹æ¯æ¬¡è°ƒç”¨éƒ½æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„idã€‚

**å¤§é‡è¯·æ±‚è¶…æ—¶å †ç§¯**ï¼š

è¶…é«˜å¹¶å‘ä¸‹ï¼Œå¤§é‡çš„è¯·æ±‚å¦‚æœéƒ½è¿›è¡Œè¶…æ—¶é‡è¯•çš„è¯ï¼Œå¦‚æœä½ çš„é‡è¯•æ—¶é—´è®¾ç½®ä¸å®‰å…¨çš„è¯ï¼Œä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚å ç”¨æœåŠ¡å™¨çº¿ç¨‹è¿›è¡Œé‡è¯•ï¼Œè¿™æ—¶å€™æœåŠ¡å™¨çº¿ç¨‹è´Ÿè½½å°±ä¼šæš´å¢ï¼Œå¯¼è‡´æœåŠ¡å™¨å®•æœºã€‚å¯¹äºè¿™ç§è¶…é«˜å¹¶å‘ä¸‹çš„é‡è¯•è®¾è®¡ï¼Œæˆ‘ä»¬ä¸èƒ½è®©é‡è¯•æ”¾åœ¨ä¸šåŠ¡çº¿ç¨‹ï¼Œè€Œæ˜¯ç»Ÿä¸€ç”±å¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œã€‚

